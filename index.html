<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è–åœ°ãƒŠãƒ“ â€” Seichi Navi | à¸•à¸²à¸¡à¸£à¸­à¸¢à¸­à¸™à¸´à¹€à¸¡à¸°à¹ƒà¸™à¸à¸µà¹ˆà¸›à¸¸à¹ˆà¸™</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@200;400;700;900&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg: #0a0a0f;
  --bg2: #12121a;
  --bg3: #1a1a26;
  --card: #16161f;
  --border: rgba(255,255,255,0.07);
  --red: #e63946;
  --red2: #ff6b6b;
  --gold: #ffd166;
  --sakura: #ffb7c5;
  --blue: #4a90e2;
  --green: #06d6a0;
  --text: #f0f0f5;
  --muted: rgba(240,240,245,0.45);
  --font-jp: 'Noto Serif JP', serif;
  --font-th: 'Sarabun', sans-serif;
  --shadow: 0 8px 32px rgba(0,0,0,0.5);
  --nav-bg: rgba(10,10,15,0.92);
}

body.light {
  --bg: #f5f5f7;
  --bg2: #ffffff;
  --bg3: #ebebf0;
  --card: #ffffff;
  --border: rgba(0,0,0,0.08);
  --text: #1a1a2e;
  --muted: rgba(26,26,46,0.5);
  --shadow: 0 8px 32px rgba(0,0,0,0.12);
  --nav-bg: rgba(245,245,247,0.92);
}
body.light ::-webkit-scrollbar-track { background: var(--bg3); }
body.light .hero::before {
  background:
    radial-gradient(ellipse 70% 60% at 50% 100%, rgba(230,57,70,0.08) 0%, transparent 70%),
    radial-gradient(ellipse 50% 50% at 20% 20%, rgba(74,144,226,0.06) 0%, transparent 60%);
}
body.light .modal { box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
body.light .leaflet-popup-content-wrapper { background:#fff!important; border-color:var(--border)!important; }
body.light .leaflet-popup-content { color:#1a1a2e!important; }
body.light .leaflet-popup-tip { background:#fff!important; }

*, *::before, *::after {
  margin:0; padding:0; box-sizing:border-box;
  transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
}
img, svg, canvas, .loc-card:hover, .loc-img-wrap img, .loader-fill, .progress-fill, .toast {
  transition: none !important;
}
.loc-card { transition: transform .3s, border-color .3s, box-shadow .3s !important; }
.loc-img-wrap img { transition: transform .4s !important; }

html { scroll-behavior: smooth; }
body {
  font-family: var(--font-th); background: var(--bg); color: var(--text);
  min-height: 100vh; overflow-x: hidden;
}

.theme-toggle {
  width: 40px; height: 40px; border-radius: 50%; background: var(--bg3); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0;
  transition: transform .3s, background .3s !important;
}
.theme-toggle:hover { transform: rotate(20deg) scale(1.1); background: var(--bg2); }

.pw-wrap { position: relative; }
.pw-wrap .form-input { padding-right: 44px; }
.pw-eye {
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
  background: none; border: none; color: var(--muted); font-size: 18px;
  cursor: pointer; padding: 4px; line-height: 1; transition: color .2s !important;
}
.pw-eye:hover { color: var(--text); }
a { color: inherit; text-decoration: none; }
button { font-family: var(--font-th); cursor: pointer; }
input, textarea, select { font-family: var(--font-th); }
img { max-width:100%; }

::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--red); border-radius:3px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADER & NAVBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loader {
  position: fixed; inset:0; background:var(--bg); display:flex; align-items:center; justify-content:center;
  z-index:9999; flex-direction:column; gap:16px; transition: opacity .5s;
}
.loader-logo { font-family: var(--font-jp); font-size: 48px; font-weight:900; color: var(--text); }
.loader-logo span { color: var(--red); }
.loader-bar { width:200px; height:3px; background: var(--bg3); border-radius:2px; overflow:hidden; }
.loader-fill { height:100%; background: var(--red); animation: loaderAnim 1.5s ease forwards; }
@keyframes loaderAnim { from{width:0} to{width:100%} }

nav {
  position: fixed; top:0; left:0; right:0; z-index:1000; background: var(--nav-bg);
  backdrop-filter: blur(20px); border-bottom: 1px solid var(--border);
  display:flex; align-items:center; gap:16px; padding: 0 40px; height:64px;
}
.nav-logo { font-family: var(--font-jp); font-size:20px; font-weight:900; white-space:nowrap; cursor:pointer; }
.nav-logo span { color:var(--red); }
.nav-links { display:flex; gap:4px; }
.nav-btn { background:none; border:none; color:var(--muted); font-size:14px; padding:8px 14px; border-radius:8px; transition: all .2s; }
.nav-btn:hover, .nav-btn.active { color:var(--text); background:var(--bg3); }
.nav-spacer { flex:1; }
.nav-search { display:flex; align-items:center; gap:8px; background:var(--bg3); border:1px solid var(--border); border-radius:24px; padding:0 16px; height:38px; }
.nav-search input { background:none; border:none; outline:none; color:var(--text); font-size:14px; width:180px; }
.nav-search input::placeholder { color:var(--muted); }
.nav-user { display:flex; align-items:center; gap:10px; }
.btn { border:none; border-radius:8px; padding:8px 18px; font-size:14px; font-weight:600; transition:all .2s; cursor:pointer; }
.btn-red { background:var(--red); color:white; }
.btn-red:hover { background:#c1121f; transform:translateY(-1px); }
.btn-outline { background:none; border:1.5px solid var(--border); color:var(--text); }
.btn-outline:hover { border-color:var(--red); color:var(--red); }
.btn-gold { background:var(--gold); color:#1a1a00; }
.btn-gold:hover { filter:brightness(1.1); }
.btn-green { background:var(--green); color:#003b2e; }
.points-badge { background:var(--bg3); border:1px solid var(--gold); border-radius:20px; padding:5px 12px; font-size:13px; color:var(--gold); display:flex; align-items:center; gap:5px; cursor:pointer; }
.user-avatar { width:36px; height:36px; border-radius:50%; background: linear-gradient(135deg,var(--red),var(--red2)); display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; cursor:pointer; overflow:hidden; }
.user-avatar img { width:100%; height:100%; object-fit:cover; }

.view { display:none; padding-top:64px; }
.view.active { display:block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hero { height: calc(100vh - 64px); min-height: 600px; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:40px; position:relative; overflow:hidden; }
.hero::before { content:''; position:absolute; inset:0; background: radial-gradient(ellipse 70% 60% at 50% 100%, rgba(230,57,70,0.12) 0%, transparent 70%), radial-gradient(ellipse 50% 50% at 20% 20%, rgba(74,144,226,0.08) 0%, transparent 60%); }
.hero-jp { font-family:var(--font-jp); font-size:13px; font-weight:400; letter-spacing:8px; color:var(--red); margin-bottom:20px; position:relative; }
.hero-title { font-family:var(--font-jp); font-size:clamp(40px,8vw,90px); font-weight:900; line-height:1.1; position:relative; }
.hero-title em { font-style:normal; color:var(--red); }
.hero-sub { font-size:clamp(14px,2vw,18px); color:var(--muted); margin-top:16px; max-width:560px; line-height:1.7; position:relative; }
.hero-cta { display:flex; gap:12px; margin-top:36px; position:relative; flex-wrap:wrap; justify-content:center; }
.season-bar { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:32px; position:relative; }
.season-pill { background:var(--bg3); border:1px solid var(--border); border-radius:24px; padding:8px 20px; font-size:14px; cursor:pointer; transition:all .2s; }
.season-pill:hover, .season-pill.active { background:var(--red); border-color:var(--red); color:white; }
.section { padding:60px 40px; max-width:1300px; margin:0 auto; }
.section-header { display:flex; align-items:baseline; gap:16px; margin-bottom:32px; flex-wrap:wrap; }
.section-title { font-family:var(--font-jp); font-size:26px; font-weight:700; }
.section-sub { font-size:14px; color:var(--muted); }
.see-all { margin-left:auto; font-size:13px; color:var(--red); cursor:pointer; }
.see-all:hover { text-decoration:underline; }

.loc-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:20px; }
.loc-card { background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; cursor:pointer; transition:all .3s; position:relative; }
.loc-card:hover { transform:translateY(-4px); border-color:rgba(230,57,70,0.3); box-shadow:0 20px 40px rgba(0,0,0,0.4); }
.loc-img-wrap { position:relative; height:180px; overflow:hidden; }
.loc-img-wrap img { width:100%; height:100%; object-fit:cover; transition:transform .4s; }
.loc-card:hover .loc-img-wrap img { transform:scale(1.06); }
.loc-cat-badge { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); border:1px solid var(--border); border-radius:6px; padding:3px 10px; font-size:11px; font-weight:600; }
.loc-season-badge { position:absolute; top:10px; right:10px; font-size:18px; }
.loc-card-body { padding:16px; }
.loc-card-title { font-size:16px; font-weight:700; margin-bottom:4px; }
.loc-card-anime { font-size:12px; color:var(--red); margin-bottom:8px; }
.loc-card-pref { font-size:12px; color:var(--muted); display:flex; align-items:center; gap:4px; }
.loc-rating { display:flex; align-items:center; gap:4px; margin-top:8px; }
.stars { color:var(--gold); font-size:12px; }
.rating-num { font-size:13px; font-weight:700; }
.review-count { font-size:12px; color:var(--muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPLORE VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cat-tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:28px; }
.cat-tab { background:var(--bg3); border:1px solid var(--border); border-radius:24px; padding:8px 18px; font-size:13px; cursor:pointer; transition:all .2s; }
.cat-tab:hover, .cat-tab.active { background:var(--red); border-color:var(--red); color:white; }
.explore-layout { display:flex; gap:24px; max-width:1400px; margin:0 auto; padding:24px 32px; }
.filter-panel { width:240px; flex-shrink:0; position:sticky; top:80px; height:fit-content; }
.filter-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; margin-bottom:16px; }
.filter-title { font-size:13px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:16px; }
.filter-opt { display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:14px; transition:all .2s; }
.filter-opt:hover { background:var(--bg3); }
.filter-opt.active { background:rgba(230,57,70,0.15); color:var(--red); }
.filter-opt input[type=radio] { accent-color:var(--red); }
.explore-main { flex:1; min-width:0; }
.explore-toolbar { display:flex; gap:12px; align-items:center; margin-bottom:20px; flex-wrap:wrap; }
.search-input { flex:1; background:var(--bg3); border:1px solid var(--border); border-radius:10px; padding:10px 16px; color:var(--text); font-size:14px; outline:none; transition:border-color .2s; min-width:200px; }
.search-input:focus { border-color:var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOCATION DETAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.detail-wrap { max-width:1100px; margin:0 auto; padding:32px; }
.detail-back { display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px; cursor:pointer; margin-bottom:24px; transition:color .2s; }
.detail-back:hover { color:var(--red); }
.detail-hero { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:32px; }
.img-compare { position:relative; border-radius:16px; overflow:hidden; }
.img-compare img { width:100%; height:300px; object-fit:cover; display:block; }
.img-label { position:absolute; bottom:12px; left:12px; background:rgba(0,0,0,0.75); border:1px solid var(--border); border-radius:8px; padding:5px 12px; font-size:12px; font-weight:600; }
.img-label.anime-label { background:rgba(230,57,70,0.8); }
.detail-info { margin-bottom:32px; }
.detail-title { font-family:var(--font-jp); font-size:32px; font-weight:900; margin-bottom:4px; }
.detail-jp { font-family:var(--font-jp); font-size:18px; font-weight:200; color:var(--muted); margin-bottom:12px; }
.detail-meta { display:flex; gap:16px; flex-wrap:wrap; margin-bottom:16px; }
.meta-chip { display:flex; align-items:center; gap:6px; font-size:13px; background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:6px 14px; }
.meta-chip .icon { font-size:16px; }
.detail-desc { font-size:16px; color:rgba(240,240,245,0.7); line-height:1.8; margin-bottom:24px; }
.detail-actions { display:flex; gap:12px; flex-wrap:wrap; }
.map-container { border-radius:16px; overflow:hidden; border:1px solid var(--border); margin-bottom:32px; }
#detail-map { height:360px; }

/* Review section */
.review-tabs { display:flex; gap:8px; margin-bottom:20px; }
.rev-tab { padding:9px 20px; border-radius:24px; font-size:14px; font-weight:600; background:var(--bg3); border:1px solid var(--border); cursor:pointer; transition:all .2s; }
.rev-tab.active { background:var(--red); border-color:var(--red); color:white; }
.review-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:12px; }
.rev-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
.rev-avatar { width:40px; height:40px; border-radius:50%; font-size:14px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--red),var(--red2)); font-weight:700; flex-shrink:0; overflow:hidden; }
.rev-avatar img { width:100%; height:100%; object-fit:cover; }
.rev-user { flex:1; }
.rev-name { font-size:15px; font-weight:700; }
.rev-meta { font-size:12px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; margin-top:2px; }
.flag { font-size:16px; }
.rev-body { font-size:15px; line-height:1.7; color:rgba(240,240,245,0.8); }
.rev-photo { width:100%; max-width:400px; border-radius:10px; margin-top:12px; }
.rev-date { font-size:12px; color:var(--muted); margin-top:8px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REVIEW FORM & UPLOAD AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.review-form { background:var(--bg3); border:1px solid var(--border); border-radius:16px; padding:28px; margin-bottom:24px; }
.form-title { font-size:18px; font-weight:700; margin-bottom:20px; }
.form-group { margin-bottom:16px; }
.form-label { font-size:13px; color:var(--muted); margin-bottom:8px; display:block; }
.form-input { width:100%; background:var(--bg2); border:1px solid var(--border); border-radius:10px; padding:11px 14px; color:var(--text); font-size:14px; outline:none; transition:border-color .2s; }
.form-input:focus { border-color:var(--red); }
.form-textarea { min-height:100px; resize:vertical; }
.star-picker { display:flex; gap:4px; }
.star-pick { font-size:28px; cursor:pointer; opacity:.3; transition:all .2s; user-select:none; }
.star-pick.lit { opacity:1; }

.upload-area { border:2px dashed var(--border); border-radius:12px; padding:24px; text-align:center; cursor:pointer; transition:all .2s; position:relative; }
.upload-area:hover { border-color:var(--red); background:rgba(230,57,70,0.05); }
.upload-preview { max-height:200px; border-radius:8px; margin-top:12px; }
.upload-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 12px; }
.preview-item { position: relative; padding-top: 100%; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
.preview-item img { position: absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
.remove-preview-btn { position: absolute; top: 4px; right: 4px; background: rgba(230,57,70,0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

.gallery-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-top: 16px; }
.gallery-row::-webkit-scrollbar { height: 6px; }
.gallery-row::-webkit-scrollbar-thumb { background: var(--red); border-radius: 3px; }
.gallery-row img { height: 80px; width: 120px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; border: 2px solid transparent; flex-shrink: 0; }
.gallery-row img:hover { transform: scale(1.05); border-color: var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REWARDS & PROFILE VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rewards-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(250px,1fr)); gap:20px; }
.reward-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; transition:all .3s; }
.reward-card:hover { border-color:rgba(255,209,102,0.3); transform:translateY(-3px); }
.reward-icon { font-size:40px; margin-bottom:16px; }
.reward-name { font-size:17px; font-weight:700; margin-bottom:6px; }
.reward-desc { font-size:13px; color:var(--muted); margin-bottom:16px; line-height:1.6; }
.reward-pts { font-size:22px; font-weight:900; color:var(--gold); display:flex; align-items:center; gap:4px; margin-bottom:12px; }
.reward-stock { font-size:12px; color:var(--muted); margin-bottom:16px; }

.profile-wrap { max-width:900px; margin:0 auto; padding:32px; }
.profile-hero { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:40px; text-align:center; margin-bottom:24px; position:relative; overflow:hidden; }
.profile-hero::before { content:'';position:absolute;inset:0; background:radial-gradient(ellipse 80% 60% at 50% 100%, rgba(230,57,70,0.1) 0%, transparent 60%); }
.profile-avatar-container { position: relative; width: 100px; height: 100px; margin: 0 auto 16px; border-radius: 50%; overflow: hidden; cursor: pointer; border: 2px solid var(--border); }
.profile-avatar-container:hover .avatar-overlay { opacity: 1; }
.profile-big-avatar { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg,var(--red),var(--red2)); font-size: 32px; font-weight: 900; }
.profile-big-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
.avatar-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; color: white; font-size: 13px; font-weight: bold; text-align: center; }
.profile-username { font-size:26px; font-weight:900; position:relative; }
.profile-level { font-size:13px; color:var(--gold); position:relative; margin-top:4px; }
.points-display { font-size:48px; font-weight:900; color:var(--gold); position:relative; margin-top:16px; }
.points-label { font-size:14px; color:var(--muted); position:relative; }
.progress-bar { background:var(--bg3); border-radius:8px; height:10px; margin-top:16px; overflow:hidden; position:relative; }
.progress-fill { height:100%; background:linear-gradient(90deg,var(--red),var(--red2)); border-radius:8px; transition:width 1s ease; }
.stats-row { display:flex; gap:16px; flex-wrap:wrap; margin-bottom:24px; }
.stat-card { flex:1; min-width:120px; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; text-align:center; }
.stat-num { font-size:28px; font-weight:900; color:var(--red); }
.stat-lbl { font-size:12px; color:var(--muted); margin-top:4px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUBMIT & ADMIN VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.submit-wrap { max-width:760px; margin:0 auto; padding:32px; }
.submit-card { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:40px; }
.submit-title { font-family:var(--font-jp); font-size:26px; font-weight:900; margin-bottom:8px; }
.submit-sub { font-size:14px; color:var(--muted); margin-bottom:32px; line-height:1.6; }
.grid2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.season-checks { display:flex; gap:12px; flex-wrap:wrap; }
.season-check-item { display:flex; align-items:center; gap:6px; font-size:14px; }
.season-check-item input { accent-color:var(--red); }
.form-select { width:100%; background:var(--bg2); border:1px solid var(--border); border-radius:10px; padding:11px 14px; color:var(--text); font-size:14px; outline:none; }

.admin-wrap { max-width:1200px; margin:0 auto; padding:32px; }
.admin-header { background:var(--card); border:1px solid rgba(230,57,70,0.3); border-radius:16px; padding:24px 32px; margin-bottom:24px; display:flex; align-items:center; gap:16px; }
.admin-badge { background:rgba(230,57,70,0.2); border:1px solid var(--red); color:var(--red); font-size:12px; font-weight:700; letter-spacing:2px; padding:5px 14px; border-radius:6px; }
.admin-login-form { max-width:380px; margin:100px auto; }
.admin-pending-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; margin-bottom:16px; }
.pending-imgs { display:flex; gap:12px; margin:12px 0; overflow-x: auto; }
.pending-imgs img { width:200px; border-radius:8px; height:140px; object-fit:cover; flex-shrink: 0; }
.admin-actions { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL & TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.75); backdrop-filter:blur(8px); z-index:2000; display:none; align-items:center; justify-content:center; padding:20px; }
.modal-overlay.open { display:flex; }
.modal { background:var(--bg2); border:1px solid var(--border); border-radius:20px; padding:36px; width:100%; max-width:480px; position:relative; animation:modalIn .25s ease; max-height: 90vh; overflow-y: auto; }
@keyframes modalIn { from{opacity:0;transform:scale(.95)} to{opacity:1;transform:scale(1)} }
.modal-close { position:absolute; top:16px; right:16px; background:none; border:none; color:var(--muted); font-size:22px; cursor:pointer; line-height:1; }
.modal-close:hover { color:var(--text); }
.modal-title { font-family:var(--font-jp); font-size:24px; font-weight:900; margin-bottom:6px; }
.modal-sub { font-size:14px; color:var(--muted); margin-bottom:28px; }
.tab-switch { display:flex; background:var(--bg3); border-radius:10px; padding:4px; margin-bottom:24px; }
.tab-sw-btn { flex:1; padding:9px; border-radius:8px; border:none; background:none; color:var(--muted); font-size:14px; font-weight:600; cursor:pointer; transition:all .2s; }
.tab-sw-btn.active { background:var(--bg2); color:var(--text); }
.country-select { width:100%; }
.error-msg { color:var(--red); font-size:13px; margin-top:8px; display:none; }
.success-msg { color:var(--green); font-size:13px; margin-top:8px; display:none; }

#toast-container { position:fixed; bottom:24px; right:24px; z-index:9999; display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
.toast { background:var(--bg2); border:1px solid var(--border); border-radius:12px; padding:14px 20px; display:flex; align-items:center; gap:10px; font-size:14px; box-shadow:0 8px 32px rgba(0,0,0,0.5); animation: toastIn .3s ease; max-width:360px; }
@keyframes toastIn { from{opacity:0;transform:translateX(60px)} to{opacity:1;transform:none} }
.toast.success { border-left:3px solid var(--green); }
.toast.error   { border-left:3px solid var(--red); }
.toast.info    { border-left:3px solid var(--blue); }
.empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
.empty-state .empty-icon { font-size:60px; margin-bottom:16px; }
.empty-state p { font-size:16px; }
.loading-spinner { text-align:center; padding:40px; color:var(--muted); font-size:14px; }
.loading-spinner::after { content:' âŒ›'; animation:spin 1s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }
.divider { border:none; border-top:1px solid var(--border); margin:32px 0; }

/* Responsive */
@media (max-width:768px) {
  nav { padding:0 16px; gap:12px; }
  .nav-links, .nav-search { display:none; }
  .section { padding:40px 16px; }
  .detail-hero, .grid2 { grid-template-columns:1fr; }
  .explore-layout { flex-direction:column; padding:16px; }
  .filter-panel { width:100%; position:static; }
  .submit-card, .profile-wrap, .detail-wrap { padding:16px; }
}
</style>
</head>
<body>

<!-- â”€â”€ LOADER â”€â”€ -->
<div id="loader">
  <div class="loader-logo">è–åœ°<span>ãƒŠãƒ“</span></div>
  <div style="font-size:14px;color:var(--muted);">à¸•à¸²à¸¡à¸£à¸­à¸¢à¸­à¸™à¸´à¹€à¸¡à¸°à¹ƒà¸™à¸à¸µà¹ˆà¸›à¸¸à¹ˆà¸™</div>
  <div class="loader-bar"><div class="loader-fill"></div></div>
</div>

<!-- â”€â”€ NAVBAR â”€â”€ -->
<nav>
  <div class="nav-logo" onclick="showView('home')">è–åœ°<span>ãƒŠãƒ“</span></div>
  <div class="nav-links">
    <button class="nav-btn active" onclick="showView('home')">ğŸ  à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</button>
    <button class="nav-btn" onclick="showView('explore')">ğŸ” à¸ªà¸³à¸£à¸§à¸ˆà¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ</button>
    <button class="nav-btn" onclick="showView('rewards')">ğŸ à¸‚à¸­à¸‡à¸£à¸²à¸‡à¸§à¸±à¸¥</button>
    <button class="nav-btn" onclick="requireLogin(()=>showView('submit'))">ğŸ“ à¹€à¸à¸´à¹ˆà¸¡à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ</button>
    <button class="nav-btn" id="navAdminBtn" onclick="showView('admin')" style="display:none">ğŸ›¡ï¸ Admin</button>
  </div>
  <div class="nav-spacer"></div>
  <div class="nav-search">
    <span>ğŸ”</span>
    <input type="text" placeholder="à¸„à¹‰à¸™à¸«à¸²à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ à¸­à¸™à¸´à¹€à¸¡à¸°..." id="globalSearch" oninput="doGlobalSearch(this.value)">
  </div>
  <button class="theme-toggle" id="themeToggleBtn" onclick="toggleTheme()" title="à¸ªà¸¥à¸±à¸šà¹‚à¸«à¸¡à¸”à¸à¸¥à¸²à¸‡à¸§à¸±à¸™/à¸à¸¥à¸²à¸‡à¸„à¸·à¸™">ğŸŒ™</button>
  <div class="nav-user" id="navUser">
    <button class="btn btn-outline" onclick="openAuthModal('login')">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button>
    <button class="btn btn-red" onclick="openAuthModal('register')">à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸</button>
  </div>
  <div class="nav-user" id="navLoggedIn" style="display:none">
    <div class="points-badge" onclick="showView('profile')">â­ <span id="navPoints">0</span> à¹à¸•à¹‰à¸¡</div>
    <div class="user-avatar" id="navAvatar" onclick="showView('profile')">U</div>
    <button class="btn btn-outline" onclick="logout()">à¸­à¸­à¸</button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VIEWS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- â”€â”€ HOME â”€â”€ -->
<div class="view active" id="view-home">
  <div class="hero">
    <div class="hero-jp">è–åœ°å·¡ç¤¼ Â· SEICHI JUNREI</div>
    <h1 class="hero-title">à¸•à¸²à¸¡à¸£à¸­à¸¢à¸­à¸™à¸´à¹€à¸¡à¸°<em>à¸à¸µà¹ˆà¸›à¸¸à¹ˆà¸™</em></h1>
    <p class="hero-sub">à¸„à¹‰à¸™à¸à¸šà¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ˆà¸£à¸´à¸‡à¸ˆà¸²à¸à¸­à¸™à¸´à¹€à¸¡à¸°à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸£à¸±à¸ à¸£à¸µà¸§à¸´à¸§ à¹à¸Šà¸£à¹Œ à¹à¸¥à¸°à¸ªà¸°à¸ªà¸¡à¹à¸•à¹‰à¸¡à¹€à¸à¸·à¹ˆà¸­à¸£à¸±à¸šà¸‚à¸­à¸‡à¸£à¸²à¸‡à¸§à¸±à¸¥</p>
    <div class="hero-cta">
      <button class="btn btn-red" onclick="showView('explore')" style="padding:14px 28px;font-size:16px;">ğŸ—¾ à¸ªà¸³à¸£à¸§à¸ˆà¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ</button>
      <button class="btn btn-outline" onclick="requireLogin(()=>showView('submit'))" style="padding:14px 28px;font-size:16px;">ğŸ“ à¹€à¸à¸´à¹ˆà¸¡à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¹ƒà¸«à¸¡à¹ˆ</button>
    </div>
    <div class="season-bar">
      <span style="font-size:14px;color:var(--muted);line-height:36px;">à¹à¸™à¸°à¸™à¸³à¸•à¸²à¸¡:</span>
      <div class="season-pill active" onclick="loadSeasonalRec('spring');setActiveSeason(this)">ğŸŒ¸ à¹ƒà¸šà¹„à¸¡à¹‰à¸œà¸¥à¸´</div>
      <div class="season-pill" onclick="loadSeasonalRec('summer');setActiveSeason(this)">â˜€ï¸ à¸£à¹‰à¸­à¸™</div>
      <div class="season-pill" onclick="loadSeasonalRec('autumn');setActiveSeason(this)">ğŸ à¹ƒà¸šà¹„à¸¡à¹‰à¸£à¹ˆà¸§à¸‡</div>
      <div class="season-pill" onclick="loadSeasonalRec('winter');setActiveSeason(this)">â„ï¸ à¸«à¸™à¸²à¸§</div>
    </div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title" id="seasonTitle">ğŸŒ¸ à¹à¸™à¸°à¸™à¸³à¸¤à¸”à¸¹à¹ƒà¸šà¹„à¸¡à¹‰à¸œà¸¥à¸´</div>
      <div class="section-sub" id="seasonSub">à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ªà¸§à¸¢à¸‡à¸²à¸¡à¸Šà¹ˆà¸§à¸‡à¸‹à¸²à¸à¸¸à¸£à¸°à¸šà¸²à¸™</div>
      <span class="see-all" onclick="showView('explore')">à¸”à¸¹à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” â†’</span>
    </div>
    <div class="loc-grid" id="seasonGrid"><div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</div></div>
  </div>

  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸœ à¸­à¸²à¸«à¸²à¸£à¸ˆà¸²à¸à¸­à¸™à¸´à¹€à¸¡à¸°</div>
      <div class="section-sub">à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£à¹à¸¥à¸°à¹€à¸¡à¸™à¸¹à¸—à¸µà¹ˆà¸›à¸£à¸²à¸à¸à¹ƒà¸™à¸­à¸™à¸´à¹€à¸¡à¸°</div>
      <span class="see-all" onclick="showExplore('food')">à¸”à¸¹à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” â†’</span>
    </div>
    <div class="loc-grid" id="foodGrid"><div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</div></div>
  </div>

  <div class="section" style="padding-top:0">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:20px;padding:36px;display:flex;gap:40px;justify-content:center;flex-wrap:wrap;text-align:center">
      <div><div style="font-size:36px;font-weight:900;color:var(--red)" id="statLoc">â€”</div><div style="color:var(--muted);font-size:14px">à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ</div></div>
      <div><div style="font-size:36px;font-weight:900;color:var(--gold)" id="statRev">â€”</div><div style="color:var(--muted);font-size:14px">à¸£à¸µà¸§à¸´à¸§</div></div>
      <div><div style="font-size:36px;font-weight:900;color:var(--green)" id="statUsr">â€”</div><div style="color:var(--muted);font-size:14px">à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰</div></div>
    </div>
  </div>
</div>

<!-- â”€â”€ EXPLORE â”€â”€ -->
<div class="view" id="view-explore">
  <div class="explore-layout">
    <div class="filter-panel">
      <div class="filter-card">
        <div class="filter-title">à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ</div>
        <div class="filter-opt active" onclick="setFilter('category','all',this)"><input type="radio" name="cat" checked> ğŸ—¾ à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
        <div class="filter-opt" onclick="setFilter('category','tourist',this)"><input type="radio" name="cat"> ğŸ›ï¸ à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸—à¹ˆà¸­à¸‡à¹€à¸—à¸µà¹ˆà¸¢à¸§</div>
        <div class="filter-opt" onclick="setFilter('category','food',this)"><input type="radio" name="cat"> ğŸœ à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£</div>
        <div class="filter-opt" onclick="setFilter('category','restaurant',this)"><input type="radio" name="cat"> ğŸ± à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£ Anime</div>
        <div class="filter-opt" onclick="setFilter('category','nature',this)"><input type="radio" name="cat"> ğŸŒ¿ à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´</div>
      </div>
      <div class="filter-card">
        <div class="filter-title">à¸¤à¸”à¸¹à¸à¸²à¸¥</div>
        <div class="filter-opt active" onclick="setFilter('season','all',this)"><input type="radio" name="sea" checked> à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
        <div class="filter-opt" onclick="setFilter('season','spring',this)"><input type="radio" name="sea"> ğŸŒ¸ à¹ƒà¸šà¹„à¸¡à¹‰à¸œà¸¥à¸´</div>
        <div class="filter-opt" onclick="setFilter('season','summer',this)"><input type="radio" name="sea"> â˜€ï¸ à¸£à¹‰à¸­à¸™</div>
        <div class="filter-opt" onclick="setFilter('season','autumn',this)"><input type="radio" name="sea"> ğŸ à¹ƒà¸šà¹„à¸¡à¹‰à¸£à¹ˆà¸§à¸‡</div>
        <div class="filter-opt" onclick="setFilter('season','winter',this)"><input type="radio" name="sea"> â„ï¸ à¸«à¸™à¸²à¸§</div>
      </div>
      <div class="filter-card">
        <div class="filter-title">à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”</div>
        <div class="filter-opt active" onclick="setFilter('prefecture','all',this)"><input type="radio" name="pref" checked> à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
        <div class="filter-opt" onclick="setFilter('prefecture','Tokyo',this)"><input type="radio" name="pref"> ğŸ—¼ Tokyo</div>
        <div class="filter-opt" onclick="setFilter('prefecture','Kyoto',this)"><input type="radio" name="pref"> â›©ï¸ Kyoto</div>
        <div class="filter-opt" onclick="setFilter('prefecture','Osaka',this)"><input type="radio" name="pref"> ğŸ¯ Osaka</div>
      </div>
    </div>
    <div class="explore-main">
      <div class="explore-toolbar">
        <input class="search-input" type="text" placeholder="ğŸ” à¸„à¹‰à¸™à¸«à¸²à¸Šà¸·à¹ˆà¸­à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ à¸«à¸£à¸·à¸­à¸­à¸™à¸´à¹€à¸¡à¸°..." id="exploreSearch" oninput="exploreSearchHandler(this.value)">
        <div id="exploreCount" style="font-size:13px;color:var(--muted);white-space:nowrap"></div>
      </div>
      <div class="loc-grid" id="exploreGrid"><div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</div></div>
    </div>
  </div>
</div>

<!-- â”€â”€ DETAIL â”€â”€ -->
<div class="view" id="view-detail">
  <div class="detail-wrap">
    <div class="detail-back" onclick="history.back(); showView(prevView||'explore')">â† à¸à¸¥à¸±à¸š</div>
    <div class="detail-hero" id="detailHero"></div>
    <div class="detail-info" id="detailInfo"></div>
    <div class="map-container"><div id="detail-map"></div></div>
    <h3 style="font-size:20px;font-weight:700;margin-bottom:20px">ğŸ’¬ à¸£à¸µà¸§à¸´à¸§à¸ˆà¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‡à¸²à¸™</h3>
    <div id="reviewFormArea"></div>
    <div class="review-tabs">
      <button class="rev-tab active" onclick="loadRevTab('all',this)">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</button>
      <button class="rev-tab" onclick="loadRevTab('local',this)">ğŸ‡¹ğŸ‡­ à¸£à¸µà¸§à¸´à¸§à¸„à¸™à¹„à¸—à¸¢</button>
      <button class="rev-tab" onclick="loadRevTab('foreign',this)">ğŸŒ à¸£à¸µà¸§à¸´à¸§à¸•à¹ˆà¸²à¸‡à¸Šà¸²à¸•à¸´</button>
    </div>
    <div id="reviewsList"></div>
  </div>
</div>

<!-- â”€â”€ REWARDS â”€â”€ -->
<div class="view" id="view-rewards">
  <div class="section">
    <div class="section-header">
      <div class="section-title">ğŸ à¹à¸¥à¸à¸‚à¸­à¸‡à¸£à¸²à¸‡à¸§à¸±à¸¥</div>
      <div class="section-sub">à¹ƒà¸Šà¹‰à¹à¸•à¹‰à¸¡à¸ªà¸°à¸ªà¸¡à¹à¸¥à¸à¸‚à¸­à¸‡à¸£à¸²à¸‡à¸§à¸±à¸¥à¸ªà¸¸à¸”à¸à¸´à¹€à¸¨à¸©à¸ˆà¸²à¸à¸­à¸™à¸´à¹€à¸¡à¸°à¹à¸¥à¸°à¸à¸²à¸£à¸—à¹ˆà¸­à¸‡à¹€à¸—à¸µà¹ˆà¸¢à¸§à¸à¸µà¹ˆà¸›à¸¸à¹ˆà¸™</div>
      <div id="myPtsDisplay" style="margin-left:auto;background:var(--bg3);border:1px solid var(--gold);border-radius:20px;padding:8px 20px;font-size:15px;color:var(--gold);font-weight:700"></div>
    </div>
    <div class="cat-tabs">
      <div class="cat-tab active" onclick="filterRewards('all',this)">à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</div>
      <div class="cat-tab" onclick="filterRewards('merchandise',this)">ğŸŒ Merchandise</div>
      <div class="cat-tab" onclick="filterRewards('travel',this)">âœˆï¸ Travel</div>
    </div>
    <div class="rewards-grid" id="rewardsGrid"><div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</div></div>
  </div>
</div>

<!-- â”€â”€ SUBMIT â”€â”€ -->
<div class="view" id="view-submit">
  <div class="submit-wrap">
    <div class="submit-card">
      <div class="submit-title">ğŸ“ à¹€à¸à¸´à¹ˆà¸¡à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¹ƒà¸«à¸¡à¹ˆ</div>
      <div class="submit-sub">à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸•à¸²à¸¡à¸£à¸­à¸¢à¸­à¸™à¸´à¹€à¸¡à¸°à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸„à¹‰à¸™à¸à¸š Admin à¸ˆà¸°à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¹ˆà¸­à¸™à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´<br>
        â­ à¸£à¸±à¸š <strong style="color:var(--gold)">200 à¹à¸•à¹‰à¸¡</strong> à¹€à¸¡à¸·à¹ˆà¸­à¸ªà¹ˆà¸‡ + <strong style="color:var(--gold)">500 à¹à¸•à¹‰à¸¡</strong> à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸”à¹‰à¸£à¸±à¸šà¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</div>

      <div id="submitForm">
        <div class="grid2">
          <div class="form-group">
            <label class="form-label">à¸Šà¸·à¹ˆà¸­à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ (à¸ à¸²à¸©à¸²à¹„à¸—à¸¢) *</label>
            <input class="form-input" id="s_name_th" placeholder="à¹€à¸Šà¹ˆà¸™ à¸¨à¸²à¸¥à¹€à¸ˆà¹‰à¸²à¸Ÿà¸¸à¸Šà¸´à¸¡à¸´ à¸­à¸´à¸™à¸²à¸£à¸´">
          </div>
          <div class="form-group">
            <label class="form-label">à¸Šà¸·à¹ˆà¸­à¸ à¸²à¸©à¸²à¸à¸µà¹ˆà¸›à¸¸à¹ˆà¸™</label>
            <input class="form-input" id="s_name_jp" placeholder="ä¼è¦‹ç¨²è·å¤§ç¤¾">
          </div>
        </div>
        <div class="grid2">
          <div class="form-group">
            <label class="form-label">à¸Šà¸·à¹ˆà¸­à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© *</label>
            <input class="form-input" id="s_name_en" placeholder="Fushimi Inari Taisha">
          </div>
          <div class="form-group">
            <label class="form-label">à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ *</label>
            <select class="form-select" id="s_category">
              <option value="tourist">ğŸ›ï¸ à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸—à¹ˆà¸­à¸‡à¹€à¸—à¸µà¹ˆà¸¢à¸§</option>
              <option value="food">ğŸœ à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£ / à¸­à¸²à¸«à¸²à¸£à¸ˆà¸²à¸à¸­à¸™à¸´à¹€à¸¡à¸°</option>
              <option value="nature">ğŸŒ¿ à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´</option>
              <option value="shopping">ğŸ›ï¸ à¸Šà¹‰à¸­à¸›à¸›à¸´à¹‰à¸‡</option>
            </select>
          </div>
        </div>
        <div class="grid2">
          <div class="form-group">
            <label class="form-label">à¸­à¸™à¸´à¹€à¸¡à¸°à¸—à¸µà¹ˆà¸›à¸£à¸²à¸à¸ *</label>
            <input class="form-input" id="s_anime" placeholder="à¹€à¸Šà¹ˆà¸™ Your Name, Spirited Away">
          </div>
          <div class="form-group">
            <label class="form-label">à¸•à¸­à¸™ / à¸‰à¸²à¸</label>
            <input class="form-input" id="s_ep" placeholder="à¹€à¸Šà¹ˆà¸™ à¸•à¸­à¸™à¸—à¸µà¹ˆ 3, Opening">
          </div>
        </div>
        <div class="grid2">
          <div class="form-group">
            <label class="form-label">à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸” *</label>
            <input class="form-input" id="s_pref" placeholder="à¹€à¸Šà¹ˆà¸™ Kyoto, Tokyo">
          </div>
          <div class="form-group">
            <label class="form-label">à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ</label>
            <input class="form-input" id="s_address" placeholder="à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹€à¸•à¹‡à¸¡">
          </div>
        </div>
        <div class="grid2">
          <div class="form-group">
            <label class="form-label">Latitude *</label>
            <input class="form-input" id="s_lat" placeholder="à¹€à¸Šà¹ˆà¸™ 34.9671" type="number" step="any">
          </div>
          <div class="form-group">
            <label class="form-label">Longitude *</label>
            <input class="form-input" id="s_lng" placeholder="à¹€à¸Šà¹ˆà¸™ 135.7727" type="number" step="any">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">à¸¤à¸”à¸¹à¸—à¸µà¹ˆà¹à¸™à¸°à¸™à¸³</label>
          <div class="season-checks">
            <label class="season-check-item"><input type="checkbox" id="s_spring" value="spring"> ğŸŒ¸ à¹ƒà¸šà¹„à¸¡à¹‰à¸œà¸¥à¸´</label>
            <label class="season-check-item"><input type="checkbox" id="s_summer" value="summer"> â˜€ï¸ à¸£à¹‰à¸­à¸™</label>
            <label class="season-check-item"><input type="checkbox" id="s_autumn" value="autumn"> ğŸ à¹ƒà¸šà¹„à¸¡à¹‰à¸£à¹ˆà¸§à¸‡</label>
            <label class="season-check-item"><input type="checkbox" id="s_winter" value="winter"> â„ï¸ à¸«à¸™à¸²à¸§</label>
          </div>
        </div>
        <div class="grid2">
          <div class="form-group">
            <label class="form-label">à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”</label>
            <input class="form-input" id="s_months" placeholder="à¹€à¸Šà¹ˆà¸™ à¸¡à¸µà¸™à¸²à¸„à¸¡-à¸à¸¤à¸©à¸ à¸²à¸„à¸¡">
          </div>
          <div class="form-group">
            <label class="form-label">à¹€à¸§à¸¥à¸²à¹€à¸›à¸´à¸”-à¸›à¸´à¸”</label>
            <input class="form-input" id="s_hours" placeholder="à¹€à¸Šà¹ˆà¸™ 09:00-18:00">
          </div>
        </div>

        <!-- à¹à¸™à¸šà¸£à¸¹à¸›à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ˆà¸£à¸´à¸‡ (à¸«à¸¥à¸²à¸¢à¸£à¸¹à¸›) -->
        <div class="form-group">
          <label class="form-label">à¸£à¸¹à¸›à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ˆà¸£à¸´à¸‡ * <small>(à¹€à¸¥à¸·à¸­à¸à¹à¸™à¸šà¹„à¸Ÿà¸¥à¹Œà¸ à¸²à¸à¹„à¸”à¹‰à¸«à¸¥à¸²à¸¢à¸£à¸¹à¸›)</small></label>
          <div class="upload-area" onclick="document.getElementById('realPhotoInput').click()">
            <div id="realUploadPrompt">ğŸ“· à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ˆà¸£à¸´à¸‡<br><small style="color:var(--muted)">JPG, PNG à¸‚à¸™à¸²à¸”à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 5MB</small></div>
          </div>
          <input type="file" id="realPhotoInput" accept="image/png, image/jpeg, image/webp" multiple style="display:none" onchange="handleLocPhotoSelect(this, 'real')">
          <div id="realUploadPreviewGrid" class="upload-preview-grid"></div>
        </div>
        
        <!-- à¹à¸™à¸šà¸£à¸¹à¸›à¸­à¸™à¸´à¹€à¸¡à¸° (à¸«à¸¥à¸²à¸¢à¸£à¸¹à¸›) -->
        <div class="form-group">
          <label class="form-label">à¸£à¸¹à¸›à¸‰à¸²à¸à¹ƒà¸™à¸­à¸™à¸´à¹€à¸¡à¸° * <small>(à¹€à¸¥à¸·à¸­à¸à¹à¸™à¸šà¹„à¸Ÿà¸¥à¹Œà¸ à¸²à¸à¹„à¸”à¹‰à¸«à¸¥à¸²à¸¢à¸£à¸¹à¸›)</small></label>
          <div class="upload-area" onclick="document.getElementById('animePhotoInput').click()">
            <div id="animeUploadPrompt">ğŸ“· à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸‰à¸²à¸à¹ƒà¸™à¸­à¸™à¸´à¹€à¸¡à¸°<br><small style="color:var(--muted)">JPG, PNG à¸‚à¸™à¸²à¸”à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 5MB</small></div>
          </div>
          <input type="file" id="animePhotoInput" accept="image/png, image/jpeg, image/webp" multiple style="display:none" onchange="handleLocPhotoSelect(this, 'anime')">
          <div id="animeUploadPreviewGrid" class="upload-preview-grid"></div>
        </div>

        <div class="form-group">
          <label class="form-label">à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢ (à¹„à¸—à¸¢)</label>
          <textarea class="form-input form-textarea" id="s_desc_th" placeholder="à¸šà¸­à¸à¹€à¸¥à¹ˆà¸²à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸™à¸µà¹‰à¹ƒà¸«à¹‰à¸™à¹ˆà¸²à¸ªà¸™à¹ƒà¸ˆ..."></textarea>
        </div>
        <div id="submitMsg" class="error-msg"></div>
        <div style="margin-top:24px">
          <button class="btn btn-red" onclick="doSubmitLocation()" style="width:100%;padding:14px;font-size:16px">ğŸ“ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ PROFILE â”€â”€ -->
<div class="view" id="view-profile">
  <div class="profile-wrap" id="profileContent">
    <div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ</div>
  </div>
</div>

<!-- â”€â”€ ADMIN â”€â”€ -->
<div class="view" id="view-admin">
  <div class="admin-wrap">
    <div id="adminLoginSection">
      <div class="admin-login-form">
        <h2 style="font-family:var(--font-jp);font-size:24px;font-weight:900;margin-bottom:8px">ğŸ›¡ï¸ Admin Panel</h2>
        <p style="color:var(--muted);font-size:14px;margin-bottom:24px">à¹ƒà¸ªà¹ˆà¸£à¸«à¸±à¸ª Admin à¹€à¸à¸·à¹ˆà¸­à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</p>
        <div class="form-group"><input class="form-input" type="password" id="adminKeyInput" placeholder="Admin Secret Key"></div>
        <button class="btn btn-red" style="width:100%;padding:12px" onclick="adminLogin()">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š Admin</button>
        <div id="adminErr" class="error-msg"></div>
      </div>
    </div>
    <div id="adminDashboard" style="display:none">
      <div class="admin-header">
        <div class="admin-badge">ADMIN</div>
        <div>
          <div style="font-size:18px;font-weight:700">Admin Dashboard</div>
          <div style="font-size:13px;color:var(--muted)">à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸—à¸µà¹ˆà¸£à¸­à¸à¸²à¸£à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</div>
        </div>
        <div id="adminStats" style="margin-left:auto;display:flex;gap:20px"></div>
      </div>
      <h3 style="font-size:18px;font-weight:700;margin-bottom:16px">ğŸ“‹ à¸£à¸²à¸¢à¸à¸²à¸£à¸£à¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š</h3>
      <div id="pendingList"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- Auth Modal -->
<div class="modal-overlay" id="authModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('authModal')">âœ•</button>
    <div class="modal-title">ğŸŒ à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸š</div>
    <div class="modal-sub" id="authSub">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸«à¸£à¸·à¸­à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸£à¸µà¸§à¸´à¸§à¹à¸¥à¸°à¸ªà¸°à¸ªà¸¡à¹à¸•à¹‰à¸¡</div>
    <div class="tab-switch">
      <button class="tab-sw-btn active" id="tabLogin" onclick="switchAuthTab('login')">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button>
      <button class="tab-sw-btn" id="tabReg" onclick="switchAuthTab('register')">à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸</button>
    </div>

    <!-- Login -->
    <div id="loginForm">
      <div class="form-group">
        <label class="form-label">Email à¸«à¸£à¸·à¸­ Username</label>
        <input class="form-input" id="loginId" placeholder="email@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <div class="pw-wrap">
          <input class="form-input" type="password" id="loginPw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          <button class="pw-eye" type="button" onclick="togglePw('loginPw',this)" tabindex="-1">ğŸ‘ï¸</button>
        </div>
      </div>
      <div id="loginErr" class="error-msg"></div>
      <button class="btn btn-red" style="width:100%;margin-top:16px;padding:12px" onclick="doLogin()">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button>
    </div>

    <!-- Register -->
    <div id="registerForm" style="display:none">
      <div class="grid2">
        <div class="form-group"><label class="form-label">Username *</label><input class="form-input" id="regUser" placeholder="coolotaku99"></div>
        <div class="form-group"><label class="form-label">à¸Šà¸·à¹ˆà¸­à¸—à¸µà¹ˆà¹à¸ªà¸”à¸‡</label><input class="form-input" id="regName" placeholder="à¸Šà¸·à¹ˆà¸­à¹€à¸¥à¹ˆà¸™"></div>
      </div>
      <div class="form-group"><label class="form-label">Email *</label><input class="form-input" id="regEmail" placeholder="email@example.com"></div>
      <div class="form-group"><label class="form-label">à¸›à¸£à¸°à¹€à¸—à¸¨à¸‚à¸­à¸‡à¸„à¸¸à¸“</label>
        <select class="form-select country-select" id="regCountry">
          <option value="TH">ğŸ‡¹ğŸ‡­ Thailand</option>
          <option value="JP">ğŸ‡¯ğŸ‡µ Japan</option>
          <option value="US">ğŸ‡ºğŸ‡¸ USA</option>
          <option value="OTHER">ğŸŒ Other</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Password * <small style="color:var(--muted)">(à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 6 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£)</small></label>
        <div class="pw-wrap"><input class="form-input" type="password" id="regPw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"><button class="pw-eye" type="button" onclick="togglePw('regPw',this)" tabindex="-1">ğŸ‘ï¸</button></div>
      </div>
      <div class="form-group">
        <label class="form-label">à¸¢à¸·à¸™à¸¢à¸±à¸™ Password *</label>
        <div class="pw-wrap"><input class="form-input" type="password" id="regPwConfirm" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" oninput="checkPwMatch()"><button class="pw-eye" type="button" onclick="togglePw('regPwConfirm',this)" tabindex="-1">ğŸ‘ï¸</button></div>
        <div id="pwMatchMsg" style="font-size:12px;margin-top:5px;display:none"></div>
      </div>
      <div id="regErr" class="error-msg"></div>
      <div id="regSuccess" class="success-msg"></div>
      <button class="btn btn-red" style="width:100%;margin-top:16px;padding:12px" onclick="doRegister()">à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸ à¸Ÿà¸£à¸µ!</button>
    </div>
  </div>
</div>

<!-- âœï¸ Modal à¸à¸¥à¹ˆà¸­à¸‡à¹à¸à¹‰à¹„à¸‚à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¹à¸¢à¸à¸Šà¸±à¸”à¹€à¸ˆà¸™ -->
<div class="modal-overlay" id="editProfileModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('editProfileModal')">âœ•</button>
    <div class="modal-title" style="text-align:center;">âœï¸ à¹à¸à¹‰à¹„à¸‚à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§</div>
    <div class="modal-sub" style="text-align:center; margin-bottom: 24px;">à¸­à¸±à¸›à¹€à¸”à¸•à¸£à¸¹à¸›à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¹à¸¥à¸°à¸Šà¸·à¹ˆà¸­à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹à¸ªà¸”à¸‡à¸œà¸¥</div>
    
    <!-- à¸ªà¹ˆà¸§à¸™à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¹ƒà¸«à¸¡à¹ˆ -->
    <div style="text-align: center; margin-bottom: 24px;">
      <div class="profile-avatar-container" style="margin: 0 auto 12px; cursor: pointer; width: 100px; height: 100px;" onclick="document.getElementById('editAvatarInput').click()">
        <div class="profile-big-avatar" id="editAvatarPreview">U</div>
        <div class="avatar-overlay">ğŸ“· à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸¹à¸›</div>
      </div>
      <input type="file" id="editAvatarInput" accept="image/png, image/jpeg, image/webp" style="display:none" onchange="handleEditAvatarSelect(this)">
      <div style="font-size:12px; color:var(--muted)">à¸„à¸¥à¸´à¸à¸—à¸µà¹ˆà¸£à¸¹à¸›à¹€à¸à¸·à¹ˆà¸­à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ (à¸‚à¸™à¸²à¸”à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 5MB)</div>
    </div>

    <!-- à¸ªà¹ˆà¸§à¸™à¹à¸à¹‰à¹„à¸‚à¸Šà¸·à¹ˆà¸­ -->
    <div class="form-group">
      <label class="form-label">à¸Šà¸·à¹ˆà¸­à¸—à¸µà¹ˆà¹à¸ªà¸”à¸‡à¸œà¸¥ (Display Name)</label>
      <input class="form-input" id="editDisplayName" placeholder="à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹à¸ªà¸”à¸‡">
    </div>

    <div id="editProfileErr" class="error-msg"></div>
    <button class="btn btn-red" style="width:100%; margin-top:16px; padding:12px" onclick="saveProfileChanges()">à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡</button>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_URL = 'https://script.google.com/macros/s/AKfycbxk543MnoJJ6AIfbrfLWrlsLI_gyq6uyqSU6vG7myxWzkKLj6NdeixPAS32R9_fPPA6UA/exec';
const ADMIN_EMAILS = ['oppo0620255009@gmail.com'];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = JSON.parse(localStorage.getItem('seichi_user') || 'null');
let currentLocation = null;
let detailMap = null;
let exploreFilters = { category:'all', season:'all', prefecture:'all', search:'' };
let allLocations = [];
let allRewards = [];
let pendingCallback = null;
let adminKey = '';
let prevView = 'explore';
let currentRevType = 'all';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  API HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiGet(params) {
  try {
    const qs = new URLSearchParams(params).toString();
    const r  = await fetch(`${API_URL}?${qs}`);
    return await r.json();
  } catch(err) {
    return { success:false, error: err.message };
  }
}

async function apiPost(data) {
  try {
    const body = new URLSearchParams();
    body.append('payload', JSON.stringify(data));
    const r = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body.toString()
    });
    return await r.json();
  } catch(err) {
    return { success:false, error: err.message };
  }
}

window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('loader').style.opacity = '0';
    setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
  }, 1000);

  initTheme();
  updateNavUser();
  loadSeasonalRec('spring');
  loadFoodGrid();
  loadStats();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  IMAGE HELPERS (DRIVE URL FIX & RESIZER)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDriveImg(url) {
  if (!url) return '';
  if (url.includes('uc?export=view&id=')) {
    return url.replace('uc?export=view&id=', 'thumbnail?id=') + '&sz=w1000';
  }
  return url;
}

function resizeImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        let width = img.width; let height = img.height;
        const maxDim = 1000; 
        if (width > maxDim || height > maxDim) {
          if (width > height) { height = Math.round((height * maxDim) / width); width = maxDim; } 
          else { width = Math.round((width * maxDim) / height); height = maxDim; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
        resolve({ dataUrl: dataUrl, base64: dataUrl.split(',')[1] });
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  THEME & UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let isDark = localStorage.getItem('seichi_theme') !== 'light';
function initTheme() {
  document.body.classList.toggle('light', !isDark);
  document.getElementById('themeToggleBtn').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
}
function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle('light', !isDark);
  const btn = document.getElementById('themeToggleBtn');
  btn.style.transform = 'rotate(360deg) scale(1.2)';
  btn.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
  setTimeout(() => btn.style.transform = '', 400);
  localStorage.setItem('seichi_theme', isDark ? 'dark' : 'light');
}
function togglePw(inputId, btn) {
  const input = document.getElementById(inputId);
  if (!input) return;
  const isHidden = input.type === 'password';
  input.type = isHidden ? 'text' : 'password';
  btn.textContent = isHidden ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
}
function checkPwMatch() {
  const pw  = document.getElementById('regPw')?.value || '';
  const pw2 = document.getElementById('regPwConfirm')?.value || '';
  const msg = document.getElementById('pwMatchMsg');
  if (!msg || !pw2) return;
  msg.style.display = 'block';
  if (pw === pw2) { msg.textContent = 'âœ… à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸•à¸£à¸‡à¸à¸±à¸™'; msg.style.color = 'var(--green)'; } 
  else { msg.textContent = 'âŒ à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸•à¸£à¸‡à¸à¸±à¸™'; msg.style.color = 'var(--red)'; }
}

function showView(name, fromView) {
  if (fromView) prevView = fromView;
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  window.scrollTo({top:0, behavior:'smooth'});

  if (name === 'explore' && allLocations.length === 0) loadExplore();
  if (name === 'rewards') loadRewards();
  if (name === 'profile' && currentUser) loadProfile();
  if (name === 'admin') initAdmin();
}
function requireLogin(cb) {
  if (currentUser) { cb(); return; }
  pendingCallback = cb;
  openAuthModal('login');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HOME â€” SEASONAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSeasonalRec(season) {
  document.getElementById('seasonGrid').innerHTML = '<div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</div>';
  const res = await apiGet({ action:'getSeasonalRec', season });
  if (!res.success) return;
  document.getElementById('seasonTitle').textContent = `${res.seasonTh} â€” à¹à¸™à¸°à¸™à¸³à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ`;
  document.getElementById('seasonSub').textContent = `à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸à¸²à¸£à¹„à¸›à¹€à¸—à¸µà¹ˆà¸¢à¸§à¹ƒà¸™${res.seasonTh}`;
  document.getElementById('seasonGrid').innerHTML = res.data.length ? res.data.map(renderLocCard).join('') : '<div class="empty-state">à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¹ƒà¸™à¸¤à¸”à¸¹à¸™à¸µà¹‰</div>';
}
async function loadFoodGrid() {
  document.getElementById('foodGrid').innerHTML = '<div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</div>';
  const res = await apiGet({ action:'getLocations', category:'food' });
  if (!res.success) return;
  document.getElementById('foodGrid').innerHTML = res.data.length ? res.data.slice(0,4).map(renderLocCard).join('') : '<div class="empty-state">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£</div>';
}
async function loadStats() {
  const res = await apiGet({ action:'getStats' });
  if (!res.success) return;
  document.getElementById('statLoc').textContent = res.stats.totalLocations;
  document.getElementById('statRev').textContent = res.stats.totalReviews;
  document.getElementById('statUsr').textContent = res.stats.totalUsers;
}
function setActiveSeason(el) {
  document.querySelectorAll('.season-pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  EXPLORE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadExplore() {
  document.getElementById('exploreGrid').innerHTML = '<div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</div>';
  const res = await apiGet({ action:'getLocations', ...exploreFilters });
  if (!res.success) { showToast('error','à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); return; }
  allLocations = res.data || [];
  renderExploreGrid(allLocations);
}
function renderExploreGrid(locs) {
  document.getElementById('exploreCount').textContent = `à¸à¸š ${locs.length} à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ`;
  document.getElementById('exploreGrid').innerHTML = locs.length ? locs.map(renderLocCard).join('') : '<div class="empty-state" style="grid-column:1/-1">à¹„à¸¡à¹ˆà¸à¸šà¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸—à¸µà¹ˆà¸„à¹‰à¸™à¸«à¸²</div>';
}
function setFilter(key, val, el) {
  exploreFilters[key] = val;
  document.querySelectorAll(`[onclick*="setFilter('${key}'"]`).forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  loadExplore();
}
let searchTimer;
function exploreSearchHandler(val) {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => { exploreFilters.search = val; loadExplore(); }, 400);
}
function doGlobalSearch(val) {
  if (!val) return;
  showView('explore');
  exploreFilters.search = val;
  document.getElementById('exploreSearch').value = val;
  loadExplore();
}
function showExplore(category) {
  exploreFilters.category = category;
  showView('explore');
  loadExplore();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  LOCATION CARD RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const catLabel = { tourist:'ğŸ›ï¸ à¸—à¹ˆà¸­à¸‡à¹€à¸—à¸µà¹ˆà¸¢à¸§', food:'ğŸœ à¸­à¸²à¸«à¸²à¸£', restaurant:'ğŸ± à¸£à¹‰à¸²à¸™à¸­à¸²à¸«à¸²à¸£', nature:'ğŸŒ¿ à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´', shopping:'ğŸ›ï¸ à¸Šà¹‰à¸­à¸›à¸›à¸´à¹‰à¸‡' };
const seaIcon  = { spring:'ğŸŒ¸', summer:'â˜€ï¸', autumn:'ğŸ', winter:'â„ï¸', all:'ğŸ—¾' };

function renderLocCard(loc) {
  const rating  = Number(loc.avg_rating||0).toFixed(1);
  const stars   = 'â˜…'.repeat(Math.round(Number(rating)));
  const seasons = String(loc.season||'').split(',').map(s=>seaIcon[s.trim()]||'').join('');
  const imgList = (loc.real_image_url || '').split(',').map(u=>u.trim()).filter(u=>u.startsWith('http'));
  const img     = imgList.length > 0 ? getDriveImg(imgList[0]) : 'https://via.placeholder.com/400x200/1a1a2e/ffffff?text=No+Image';
  
  return `
    <div class="loc-card" onclick="openDetail('${loc.location_id}')">
      <div class="loc-img-wrap">
        <img src="${img}" alt="${loc.name_th}" onerror="this.src='https://via.placeholder.com/400x200/1a1a2e/ffffff?text=No+Image'">
        <div class="loc-cat-badge">${catLabel[loc.category]||loc.category}</div>
        <div class="loc-season-badge">${seasons}</div>
      </div>
      <div class="loc-card-body">
        <div class="loc-card-title">${loc.name_th||loc.name_en}</div>
        <div class="loc-card-anime">ğŸ¬ ${loc.anime_title}</div>
        <div class="loc-card-pref"><span class="icon">ğŸ“</span>${loc.prefecture}</div>
        ${Number(loc.review_count)>0 ? `<div class="loc-rating"><span class="stars">${stars}</span><span class="rating-num">${rating}</span><span class="review-count">(${loc.review_count} à¸£à¸µà¸§à¸´à¸§)</span></div>` : '<div style="font-size:12px;color:var(--muted);margin-top:8px">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸µà¸§à¸´à¸§</div>'}
      </div>
    </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  LOCATION DETAIL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openDetail(id) {
  prevView = document.querySelector('.view.active')?.id?.replace('view-','') || 'explore';
  showView('detail');
  document.getElementById('detailHero').innerHTML = '<div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</div>';
  document.getElementById('reviewsList').innerHTML = '';

  const res = await apiGet({ action:'getLocationById', id });
  if (!res.success) { showToast('error','à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ'); return; }
  currentLocation = res.data;
  renderDetail(res.data);
}

function renderDetail(loc) {
  const realImgList = (loc.real_image_url || '').split(',').map(u=>getDriveImg(u.trim())).filter(u=>u.startsWith('http'));
  const animeImgList = (loc.anime_image_url || '').split(',').map(u=>getDriveImg(u.trim())).filter(u=>u.startsWith('http'));
  
  const realImg  = realImgList[0] || 'https://via.placeholder.com/600x300/1a1a2e/ffffff?text=Real+Photo';
  const animeImg = animeImgList[0] || 'https://via.placeholder.com/600x300/2d1a1a/ffffff?text=Anime+Scene';
  const rating   = Number(loc.avg_rating||0).toFixed(1);
  const stars    = 'â˜…'.repeat(Math.round(Number(rating)));
  const seasons  = String(loc.season||'').split(',').map(s => ({spring:'ğŸŒ¸ à¹ƒà¸šà¹„à¸¡à¹‰à¸œà¸¥à¸´',summer:'â˜€ï¸ à¸£à¹‰à¸­à¸™',autumn:'ğŸ à¹ƒà¸šà¹„à¸¡à¹‰à¸£à¹ˆà¸§à¸‡',winter:'â„ï¸ à¸«à¸™à¸²à¸§',all:'à¸•à¸¥à¸­à¸”à¸›à¸µ'}[s.trim()]||s.trim())).join(' Â· ');

  document.getElementById('detailHero').innerHTML = `
    <div class="img-compare"><img id="mainRealImg" src="${realImg}" onerror="this.src='https://via.placeholder.com/600x300/1a1a2e/ffffff?text=Real+Photo'"><div class="img-label">ğŸ“¸ à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ˆà¸£à¸´à¸‡</div></div>
    <div class="img-compare"><img id="mainAnimeImg" src="${animeImg}" onerror="this.src='https://via.placeholder.com/600x300/2d1a1a/ffffff?text=Anime+Scene'"><div class="img-label anime-label">ğŸ¬ à¸‰à¸²à¸à¹ƒà¸™à¸­à¸™à¸´à¹€à¸¡à¸°</div></div>`;

  let extraGalleryHtml = '';
  if (realImgList.length > 1 || animeImgList.length > 1) {
      extraGalleryHtml = `<div style="grid-column: 1 / -1; margin-top: -16px; margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px; color: var(--muted);">ğŸ“¸ à¸£à¸¹à¸›à¸ à¸²à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸¹à¸›à¹ƒà¸«à¸à¹ˆ)</div>
          <div class="gallery-row">
              ${realImgList.map(url => `<img src="${url}" onclick="document.getElementById('mainRealImg').src=this.src" title="à¸”à¸¹à¸£à¸¹à¸›à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ˆà¸£à¸´à¸‡">`).join('')}
              ${animeImgList.map(url => `<img src="${url}" onclick="document.getElementById('mainAnimeImg').src=this.src" style="border: 2px solid var(--red)" title="à¸”à¸¹à¸£à¸¹à¸›à¸­à¸™à¸´à¹€à¸¡à¸°">`).join('')}
          </div>
      </div>`;
  }

  document.getElementById('detailInfo').innerHTML = `
    ${extraGalleryHtml}
    <div class="detail-title">${loc.name_th||loc.name_en}</div>
    <div class="detail-jp">${loc.name_jp||''} ${loc.name_en ? 'Â· '+loc.name_en : ''}</div>
    <div class="detail-meta">
      <div class="meta-chip"><span class="icon">ğŸ¬</span>${loc.anime_title}</div>
      ${loc.anime_episode?`<div class="meta-chip"><span class="icon">â–¶ï¸</span>${loc.anime_episode}</div>`:''}
      <div class="meta-chip"><span class="icon">ğŸ“</span>${loc.prefecture}</div>
      ${loc.opening_hours?`<div class="meta-chip"><span class="icon">ğŸ•</span>${loc.opening_hours}</div>`:''}
      ${seasons?`<div class="meta-chip"><span class="icon">ğŸ—“ï¸</span>${seasons}</div>`:''}
      ${loc.best_months?`<div class="meta-chip"><span class="icon">âœ¨</span>à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”: ${loc.best_months}</div>`:''}
    </div>
    ${Number(loc.review_count)>0 ? `<div class="loc-rating" style="font-size:18px;margin-bottom:16px"><span style="color:var(--gold)">${stars}</span><span style="font-weight:900;font-size:20px">${rating}</span><span style="color:var(--muted);font-size:14px">(${loc.review_count} à¸£à¸µà¸§à¸´à¸§)</span></div>`:''}
    <div class="detail-desc">${loc.description_th || loc.description_en || ''}</div>
    <div class="detail-actions">
      <button class="btn btn-red" onclick="openMapsFromDetail()">ğŸ—ºï¸ à¸™à¸³à¸—à¸²à¸‡à¹ƒà¸™ Google Maps</button>
      ${currentUser ? `<button class="btn btn-outline" onclick="scrollToReview()">âœï¸ à¹€à¸‚à¸µà¸¢à¸™à¸£à¸µà¸§à¸´à¸§</button>` : `<button class="btn btn-outline" onclick="openAuthModal('login')">ğŸ”’ Login à¹€à¸à¸·à¹ˆà¸­à¸£à¸µà¸§à¸´à¸§</button>`}
    </div>`;

  initDetailMap(parseFloat(loc.lat), parseFloat(loc.lng), loc.name_th||loc.name_en, loc.anime_title);

  if (currentUser) {
    document.getElementById('reviewFormArea').innerHTML = renderReviewForm();
    initStarPicker();
  } else {
    document.getElementById('reviewFormArea').innerHTML = `<div style="background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:24px;text-align:center;margin-bottom:24px"><div style="font-size:16px;margin-bottom:12px">ğŸ”’ Login à¹€à¸à¸·à¹ˆà¸­à¹€à¸‚à¸µà¸¢à¸™à¸£à¸µà¸§à¸´à¸§à¹à¸¥à¸°à¸ªà¸°à¸ªà¸¡à¹à¸•à¹‰à¸¡</div><button class="btn btn-red" onclick="openAuthModal('login')">à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š</button></div>`;
  }
  loadRevTab('all', document.querySelector('.rev-tab'));
}

function openMaps(lat, lng, name) { window.open('https://www.google.com/maps/search/' + encodeURIComponent(name) + '/@' + lat + ',' + lng + ',15z', '_blank'); }
function openMapsFromDetail() { if (currentLocation) openMaps(currentLocation.lat, currentLocation.lng, currentLocation.name_en || currentLocation.name_th || ''); }
function scrollToReview() { document.getElementById('reviewFormArea').scrollIntoView({ behavior:'smooth' }); }

function initDetailMap(lat, lng, name, anime) {
  if (detailMap) { detailMap.remove(); detailMap = null; }
  if (!lat || !lng || isNaN(lat) || isNaN(lng)) { document.getElementById('detail-map').innerHTML = '<div class="loading-spinner" style="padding:100px">à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸´à¸à¸±à¸”</div>'; return; }
  setTimeout(() => {
    detailMap = L.map('detail-map').setView([lat, lng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(detailMap);
    const icon = L.divIcon({ html:`<div style="background:var(--red);width:14px;height:14px;border-radius:50%;border:3px solid white;box-shadow:0 0 0 3px rgba(230,57,70,.3)"></div>`, iconSize:[14,14], className:'' });
    L.marker([lat,lng], {icon}).addTo(detailMap).bindPopup(`<div class="map-popup-title">${name}</div><div class="map-popup-anime">ğŸ¬ ${anime}</div><div class="map-popup-btn" onclick="openMapsFromDetail()">à¸™à¸³à¸—à¸²à¸‡ â†’</div>`).openPopup();
  }, 100);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  REVIEW FORM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReviewForm() {
  return `
    <div class="review-form" id="writeReview">
      <div class="form-title">âœï¸ à¹€à¸‚à¸µà¸¢à¸™à¸£à¸µà¸§à¸´à¸§à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸™à¸µà¹‰</div>
      <div class="form-group"><label class="form-label">à¹ƒà¸«à¹‰à¸„à¸°à¹à¸™à¸™</label><div class="star-picker" id="starPicker">${[1,2,3,4,5].map(i=>`<span class="star-pick" data-star="${i}" onclick="setStar(${i})">â˜…</span>`).join('')}</div></div>
      <div class="form-group"><label class="form-label">à¹€à¸‚à¸µà¸¢à¸™à¸£à¸µà¸§à¸´à¸§</label><textarea class="form-input form-textarea" id="revComment" placeholder="à¸šà¸­à¸à¹€à¸¥à¹ˆà¸²à¸›à¸£à¸°à¸ªà¸šà¸à¸²à¸£à¸“à¹Œà¸—à¸µà¹ˆà¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸™à¸µà¹‰..."></textarea></div>
      <div class="grid2">
        <div class="form-group"><label class="form-label">à¸§à¸±à¸™à¸—à¸µà¹ˆà¹„à¸›à¹€à¸—à¸µà¹ˆà¸¢à¸§</label><input class="form-input" type="date" id="revDate"></div>
        <div class="form-group"><label class="form-label">à¸¤à¸”à¸¹à¸—à¸µà¹ˆà¹„à¸›</label>
          <select class="form-select" id="revSeason">
            <option value="">à¹€à¸¥à¸·à¸­à¸à¸¤à¸”à¸¹</option><option value="spring">ğŸŒ¸ à¹ƒà¸šà¹„à¸¡à¹‰à¸œà¸¥à¸´</option><option value="summer">â˜€ï¸ à¸£à¹‰à¸­à¸™</option><option value="autumn">ğŸ à¹ƒà¸šà¹„à¸¡à¹‰à¸£à¹ˆà¸§à¸‡</option><option value="winter">â„ï¸ à¸«à¸™à¸²à¸§</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">à¹à¸™à¸šà¸£à¸¹à¸›à¸–à¹ˆà¸²à¸¢ (à¸£à¸±à¸š +50 à¹à¸•à¹‰à¸¡à¸à¸´à¹€à¸¨à¸©!)</label>
        <div class="upload-area" onclick="document.getElementById('photoInput').click()">
          <div id="uploadPrompt">ğŸ“· à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸à¸£à¸¹à¸›à¸–à¹ˆà¸²à¸¢à¸—à¸µà¹ˆà¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸™à¸µà¹‰<br><small style="color:var(--muted)">JPG, PNG à¸‚à¸™à¸²à¸”à¹„à¸¡à¹ˆà¹€à¸à¸´à¸™ 5MB</small></div>
        </div>
        <input type="file" id="photoInput" accept="image/png, image/jpeg, image/webp" style="display:none" onchange="handlePhotoSelect(this)">
        <img id="uploadPreview" class="upload-preview" style="display:none">
      </div>
      <div id="revMsg" class="error-msg"></div>
      <div style="margin-top:16px;display:flex;gap:10px;align-items:center">
        <button class="btn btn-red" onclick="doAddReview()" style="padding:12px 28px">ğŸ“¤ à¸ªà¹ˆà¸‡à¸£à¸µà¸§à¸´à¸§ (+50 à¹à¸•à¹‰à¸¡)</button>
        <span style="font-size:13px;color:var(--muted)">à¸¡à¸µà¸£à¸¹à¸› = +100 à¹à¸•à¹‰à¸¡</span>
      </div>
    </div>`;
}

let selectedStar = 5;
let photoBase64 = null;
function initStarPicker() { setStar(5); }
function setStar(n) { selectedStar = n; document.querySelectorAll('.star-pick').forEach((s, i) => { s.classList.toggle('lit', i < n); }); }

async function handlePhotoSelect(input) {
  const file = input.files[0];
  if (!file) return;
  if (!file.type.startsWith('image/')) { showToast('error','à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œà¸£à¸¹à¸›à¸ à¸²à¸'); return; }
  try {
    const resized = await resizeImage(file);
    photoBase64 = resized.base64;
    document.getElementById('uploadPreview').src = resized.dataUrl;
    document.getElementById('uploadPreview').style.display = 'block';
    document.getElementById('uploadPrompt').style.display = 'none';
  } catch(e) { showToast('error', 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œà¹„à¸”à¹‰'); }
}

async function doAddReview() {
  if (!currentUser) { openAuthModal('login'); return; }
  const comment = document.getElementById('revComment').value.trim();
  if (!comment) { showMsg('revMsg','à¸à¸£à¸¸à¸“à¸²à¹€à¸‚à¸µà¸¢à¸™à¸£à¸µà¸§à¸´à¸§'); return; }

  const btn = document.querySelector('#writeReview .btn-red');
  btn.textContent = 'à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡...'; btn.disabled = true;

  let photo_url = '';
  if (photoBase64) {
    const up = await apiPost({ action:'uploadImage', userId:currentUser.userId, token:currentUser.token, base64:photoBase64, mimeType:'image/jpeg', filename:'review.jpg' });
    if (up.success) photo_url = up.url;
  }

  const res = await apiPost({ action:'addReview', userId:currentUser.userId, token:currentUser.token, locationId: currentLocation.location_id, rating: selectedStar, comment, photo_url, visit_date: document.getElementById('revDate').value, season_visited: document.getElementById('revSeason').value });
  btn.textContent = 'ğŸ“¤ à¸ªà¹ˆà¸‡à¸£à¸µà¸§à¸´à¸§'; btn.disabled = false;

  if (res.success) {
    showToast('success', `à¸£à¸µà¸§à¸´à¸§à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! ğŸ‰ +${res.points_earned} à¹à¸•à¹‰à¸¡`);
    currentUser.points = (Number(currentUser.points||0)) + res.points_earned;
    localStorage.setItem('seichi_user', JSON.stringify(currentUser));
    updateNavUser(); loadRevTab(currentRevType, document.querySelector('.rev-tab.active'));
    document.getElementById('revComment').value = ''; photoBase64 = null;
    document.getElementById('uploadPreview').style.display = 'none'; document.getElementById('uploadPrompt').style.display = 'block'; setStar(5);
  } else { showMsg('revMsg', res.error); }
}

async function loadRevTab(type, el) {
  currentRevType = type;
  document.querySelectorAll('.rev-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  document.getElementById('reviewsList').innerHTML = '<div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸£à¸µà¸§à¸´à¸§</div>';
  if (!currentLocation) return;
  const res = await apiGet({ action:'getReviews', locationId:currentLocation.location_id, type });
  if (!res.success || !res.data.length) { document.getElementById('reviewsList').innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ’¬</div><p>à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸µà¸§à¸´à¸§ â€” à¸¡à¸²à¹€à¸›à¹‡à¸™à¸„à¸™à¹à¸£à¸à¸à¸±à¸™!</p></div>'; return; }
  const flags = { TH:'ğŸ‡¹ğŸ‡­', JP:'ğŸ‡¯ğŸ‡µ', US:'ğŸ‡ºğŸ‡¸', SG:'ğŸ‡¸ğŸ‡¬', MY:'ğŸ‡²ğŸ‡¾', PH:'ğŸ‡µğŸ‡­', ID:'ğŸ‡®ğŸ‡©', VN:'ğŸ‡»ğŸ‡³', CN:'ğŸ‡¨ğŸ‡³', KR:'ğŸ‡°ğŸ‡·', GB:'ğŸ‡¬ğŸ‡§' };
  document.getElementById('reviewsList').innerHTML = res.data.map(r => {
    const avUrl = getDriveImg(r.avatar_url);
    const avHtml = avUrl ? `<img src="${avUrl}" style="width:100%;height:100%;object-fit:cover;">` : (r.username||'U')[0].toUpperCase();
    return `<div class="review-card"><div class="rev-header"><div class="rev-avatar">${avHtml}</div><div class="rev-user"><div class="rev-name">${r.username} <span class="flag">${flags[r.country]||'ğŸŒ'}</span></div><div class="rev-meta"><span>${'â˜…'.repeat(Number(r.rating))}</span>${r.visit_date ? `<span>ğŸ“… ${r.visit_date}</span>` : ''}${r.season_visited ? `<span>${{spring:'ğŸŒ¸',summer:'â˜€ï¸',autumn:'ğŸ',winter:'â„ï¸'}[r.season_visited]||''}</span>` : ''}</div></div></div><div class="rev-body">${r.comment}</div>${r.photo_url ? `<img src="${getDriveImg(r.photo_url)}" class="rev-photo" onerror="this.style.display='none'">` : ''}<div class="rev-date">${new Date(r.review_date).toLocaleDateString('th-TH', {year:'numeric',month:'long',day:'numeric'})}</div></div>`}).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  REWARDS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRewards() {
  document.getElementById('rewardsGrid').innerHTML = '<div class="loading-spinner">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”</div>';
  document.getElementById('myPtsDisplay').textContent = currentUser ? `â­ ${currentUser.points||0} à¹à¸•à¹‰à¸¡à¸‚à¸­à¸‡à¸‰à¸±à¸™` : '';
  const res = await apiGet({ action:'getRewards' });
  if (!res.success) return;
  allRewards = res.data || [];
  renderRewards(allRewards);
}
function renderRewards(rewards) {
  const icons = { merchandise:'ğŸŒ', travel:'âœˆï¸' };
  document.getElementById('rewardsGrid').innerHTML = rewards.length ? rewards.map(r => `<div class="reward-card"><div class="reward-icon">${icons[r.category]||'ğŸ'}</div><div class="reward-name">${r.name}</div><div class="reward-desc">${r.description}</div><div class="reward-pts">â­ ${Number(r.points_required).toLocaleString()}</div><div class="reward-stock">à¹€à¸«à¸¥à¸·à¸­: ${r.stock} à¸Šà¸´à¹‰à¸™</div><button class="btn ${currentUser && currentUser.points >= r.points_required ? 'btn-gold' : 'btn-outline'}" onclick="doClaimReward('${r.reward_id}','${r.name}')" style="width:100%">${currentUser && currentUser.points >= r.points_required ? 'ğŸ à¹à¸¥à¸à¸£à¸²à¸‡à¸§à¸±à¸¥' : 'ğŸ”’ à¹à¸•à¹‰à¸¡à¹„à¸¡à¹ˆà¸à¸­'}</button></div>`).join('') : '<div class="empty-state" style="grid-column:1/-1">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¸­à¸‡à¸£à¸²à¸‡à¸§à¸±à¸¥</div>';
}
function filterRewards(cat, el) {
  document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active')); el.classList.add('active');
  renderRewards(cat === 'all' ? allRewards : allRewards.filter(r => r.category === cat));
}
async function doClaimReward(rewardId, name) {
  if (!currentUser) { openAuthModal('login'); return; }
  if (!confirm(`à¹à¸¥à¸ "${name}" à¹ƒà¸Šà¹‰à¹à¸•à¹‰à¸¡à¸ªà¸°à¸ªà¸¡à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?`)) return;
  const res = await apiPost({ action:'claimReward', userId:currentUser.userId, token:currentUser.token, rewardId });
  if (res.success) { showToast('success', res.message); currentUser.points = res.remaining_points; localStorage.setItem('seichi_user', JSON.stringify(currentUser)); updateNavUser(); loadRewards(); } else { showToast('error', res.error); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PROFILE & MODAL à¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¹ˆà¸§à¸™à¸•à¸±à¸§
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProfile() {
  if (!currentUser) { showView('home'); openAuthModal('login'); return; }
  const nextLvlPts = (currentUser.level||1) * 500;
  const progress = Math.min(100, ((currentUser.points||0) % 500) / 500 * 100);
  const avUrl = getDriveImg(currentUser.avatar_url);
  const avHtml = avUrl ? `<img src="${avUrl}" alt="Avatar">` : `${(currentUser.username||'U')[0].toUpperCase()}`;

  document.getElementById('profileContent').innerHTML = `
    <div class="profile-hero">
      <div class="profile-avatar-container" style="margin: 0 auto 16px; border:none; cursor:default">
        <div class="profile-big-avatar">${avHtml}</div>
      </div>
      <div class="profile-username">${currentUser.display_name||currentUser.username}</div>
      <button class="btn btn-outline" style="padding:6px 14px;font-size:13px;margin-top:8px" onclick="openEditProfile()">âœï¸ à¹à¸à¹‰à¹„à¸‚à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ</button>
      <div class="profile-level" style="margin-top:16px">âš”ï¸ Level ${currentUser.level||1} Seichi Explorer</div>
      <div class="points-display">${Number(currentUser.points||0).toLocaleString()}</div>
      <div class="points-label">à¹à¸•à¹‰à¸¡à¸ªà¸°à¸ªà¸¡</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
      <div style="font-size:12px;color:var(--muted);margin-top:8px;position:relative">${Math.round((currentUser.points||0) % 500)} / 500 à¹à¸•à¹‰à¸¡ à¸ªà¸¹à¹ˆ Level ${(currentUser.level||1)+1}</div>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-num">${currentUser.points||0}</div><div class="stat-lbl">à¹à¸•à¹‰à¸¡à¸ªà¸°à¸ªà¸¡</div></div>
      <div class="stat-card"><div class="stat-num">${currentUser.level||1}</div><div class="stat-lbl">Level</div></div>
      <div class="stat-card"><div class="stat-num">${currentUser.country||'TH'}</div><div class="stat-lbl">à¸›à¸£à¸°à¹€à¸—à¸¨</div></div>
    </div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;margin-bottom:20px">
      <div style="font-size:17px;font-weight:700;margin-bottom:16px">ğŸ’¡ à¸§à¸´à¸˜à¸µà¸ªà¸°à¸ªà¸¡à¹à¸•à¹‰à¸¡</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        ${[['âœï¸ à¹€à¸‚à¸µà¸¢à¸™à¸£à¸µà¸§à¸´à¸§','50 à¹à¸•à¹‰à¸¡'],['ğŸ“· à¸£à¸µà¸§à¸´à¸§à¸à¸£à¹‰à¸­à¸¡à¸£à¸¹à¸›','100 à¹à¸•à¹‰à¸¡'],['ğŸ“ à¸ªà¹ˆà¸‡à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¹ƒà¸«à¸¡à¹ˆ','200 à¹à¸•à¹‰à¸¡'],['âœ… à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¸­à¸™à¸¸à¸¡à¸±à¸•à¸´','500 à¹à¸•à¹‰à¸¡']].map(([a,b])=>`<div style="display:flex;justify-content:space-between;padding:10px 14px;background:var(--bg3);border-radius:8px"><span style="font-size:14px">${a}</span><span style="color:var(--gold);font-weight:700">+${b}</span></div>`).join('')}
      </div>
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <button class="btn btn-red" onclick="showView('rewards')" style="flex:1;padding:12px">ğŸ à¹à¸¥à¸à¸‚à¸­à¸‡à¸£à¸²à¸‡à¸§à¸±à¸¥</button>
      <button class="btn btn-outline" onclick="requireLogin(()=>showView('submit'))" style="flex:1;padding:12px">ğŸ“ à¹€à¸à¸´à¹ˆà¸¡à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ</button>
    </div>`;
}

// â”€â”€ à¸£à¸°à¸šà¸šà¹à¸à¹‰à¹„à¸‚à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¸œà¹ˆà¸²à¸™ Modal â”€â”€
let stagedAvatarBase64 = null;

function openEditProfile() {
  stagedAvatarBase64 = null;
  document.getElementById('editDisplayName').value = currentUser.display_name || currentUser.username;
  const avUrl = getDriveImg(currentUser.avatar_url);
  const avHtml = avUrl ? `<img src="${avUrl}" style="width:100%;height:100%;object-fit:cover;">` : `${(currentUser.username||'U')[0].toUpperCase()}`;
  document.getElementById('editAvatarPreview').innerHTML = avHtml;
  document.getElementById('editProfileErr').style.display = 'none';
  openModal('editProfileModal');
}

async function handleEditAvatarSelect(input) {
  const file = input.files[0];
  if (!file) return;
  if (!file.type.startsWith('image/')) { showMsg('editProfileErr', 'à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œà¸£à¸¹à¸›à¸ à¸²à¸'); return; }
  try {
    const resized = await resizeImage(file);
    stagedAvatarBase64 = resized.base64;
    document.getElementById('editAvatarPreview').innerHTML = `<img src="${resized.dataUrl}" style="width:100%;height:100%;object-fit:cover;">`;
  } catch(e) { showMsg('editProfileErr', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œ'); }
}

async function saveProfileChanges() {
  const newName = document.getElementById('editDisplayName').value.trim();
  if (!newName) { showMsg('editProfileErr', 'à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸—à¸µà¹ˆà¹à¸ªà¸”à¸‡à¸œà¸¥'); return; }
  const btn = document.querySelector('#editProfileModal .btn-red');
  btn.textContent = 'à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸...'; btn.disabled = true;

  let successMsg = []; let errMsg = [];
  if (newName !== currentUser.display_name && newName !== currentUser.username) {
    const resN = await apiPost({ action:'updateProfile', userId: currentUser.userId, token: currentUser.token, display_name: newName });
    if (resN.success) { currentUser.display_name = newName; successMsg.push('à¸Šà¸·à¹ˆà¸­'); } else errMsg.push(resN.error);
  }
  if (stagedAvatarBase64) {
    const resA = await apiPost({ action:'updateAvatar', userId: currentUser.userId, token: currentUser.token, base64: stagedAvatarBase64 });
    if (resA.success) { currentUser.avatar_url = resA.avatar_url; successMsg.push('à¸£à¸¹à¸›à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ'); } else errMsg.push(resA.error);
  }

  btn.textContent = 'à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡'; btn.disabled = false;
  if (errMsg.length > 0) { showMsg('editProfileErr', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ' + errMsg.join(', ')); } 
  else if (successMsg.length > 0) {
    localStorage.setItem('seichi_user', JSON.stringify(currentUser));
    updateNavUser(); loadProfile(); closeModal('editProfileModal'); showToast('success', 'à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ ' + successMsg.join(' à¹à¸¥à¸° ') + ' à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! ğŸ‰');
  } else { closeModal('editProfileModal'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SUBMIT LOCATION (MULTI-IMAGE UPLOADS)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let realImagesList = [];
let animeImagesList = [];
let imgCounterId = 0;

async function handleLocPhotoSelect(input, type) {
  const files = input.files;
  if (!files || files.length === 0) return;

  for (let file of Array.from(files)) {
    if (!file.type.startsWith('image/')) { showToast('error', 'à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸£à¸¹à¸›à¸ à¸²à¸à¸ˆà¸°à¸–à¸¹à¸à¸‚à¹‰à¸²à¸¡à¹„à¸›'); continue; }
    try {
      const resized = await resizeImage(file);
      const imgObj = { id: imgCounterId++, base64: resized.base64, dataUrl: resized.dataUrl };
      if (type === 'real') { realImagesList.push(imgObj); renderImagePreviews('real'); } 
      else { animeImagesList.push(imgObj); renderImagePreviews('anime'); }
    } catch(err) { showToast('error', 'à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œà¸£à¸¹à¸›à¸ à¸²à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ'); }
  }
  input.value = ''; // à¸£à¸µà¹€à¸‹à¹‡à¸•à¹ƒà¸«à¹‰à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œà¸‹à¹‰à¸³à¹„à¸”à¹‰
}

function removeLocImage(type, id) {
  if (type === 'real') { realImagesList = realImagesList.filter(img => img.id !== id); renderImagePreviews('real'); } 
  else { animeImagesList = animeImagesList.filter(img => img.id !== id); renderImagePreviews('anime'); }
}

function renderImagePreviews(type) {
  const images = type === 'real' ? realImagesList : animeImagesList;
  const containerId = type === 'real' ? 'realUploadPreviewGrid' : 'animeUploadPreviewGrid';
  const promptId = type === 'real' ? 'realUploadPrompt' : 'animeUploadPrompt';
  document.getElementById(containerId).innerHTML = images.map(img => `<div class="preview-item"><img src="${img.dataUrl}"><button class="remove-preview-btn" type="button" onclick="event.stopPropagation(); removeLocImage('${type}', ${img.id})">âœ•</button></div>`).join('');
  document.getElementById(promptId).style.display = images.length > 0 ? 'none' : 'block';
}

async function doSubmitLocation() {
  if (!currentUser) { openAuthModal('login'); return; }
  const seasons = ['spring','summer','autumn','winter'].filter(s => document.getElementById('s_'+s)?.checked);
  const data = {
    action:'submitLocation', userId: currentUser.userId, token: currentUser.token,
    name_th: document.getElementById('s_name_th').value.trim(), name_jp: document.getElementById('s_name_jp').value.trim(), name_en: document.getElementById('s_name_en').value.trim(),
    category: document.getElementById('s_category').value, anime_title: document.getElementById('s_anime').value.trim(), anime_ep: document.getElementById('s_ep').value.trim(),
    prefecture: document.getElementById('s_pref').value.trim(), address: document.getElementById('s_address').value.trim(), lat: document.getElementById('s_lat').value, lng: document.getElementById('s_lng').value,
    season: seasons.join(',') || 'all', best_months: document.getElementById('s_months').value.trim(), hours: document.getElementById('s_hours').value.trim(),
    real_base64_list: realImagesList.map(img => img.base64), anime_base64_list: animeImagesList.map(img => img.base64), desc_th: document.getElementById('s_desc_th').value.trim()
  };

  if (!data.name_th || !data.name_en || !data.anime_title || !data.prefecture || !data.lat || !data.lng) { showMsg('submitMsg','à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™ (à¸¡à¸µ *)'); return; }
  if (data.real_base64_list.length === 0 || data.anime_base64_list.length === 0) { showMsg('submitMsg','à¸à¸£à¸¸à¸“à¸²à¹à¸™à¸šà¸£à¸¹à¸›à¸ à¸²à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 1 à¸£à¸¹à¸›à¸—à¸±à¹‰à¸‡à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸ˆà¸£à¸´à¸‡à¹à¸¥à¸°à¸­à¸™à¸´à¹€à¸¡à¸°'); return; }

  const btn = document.querySelector('#submitForm .btn-red');
  btn.textContent = 'à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡ (à¸£à¸§à¸¡à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸¥à¸‡ Google Drive)...'; btn.disabled = true;

  const res = await apiPost(data);
  btn.textContent = 'ğŸ“ à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ'; btn.disabled = false;

  if (res.success) {
    showToast('success', `à¸ªà¹ˆà¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! ğŸ‰ à¸£à¸­ Admin à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š (+${POINTS_DISPLAY.SUBMIT_LOCATION} à¹à¸•à¹‰à¸¡)`);
    currentUser.points = (Number(currentUser.points||0)) + 200; localStorage.setItem('seichi_user', JSON.stringify(currentUser)); updateNavUser();
    document.querySelectorAll('#submitForm input[type="text"], #submitForm input[type="number"], #submitForm textarea').forEach(i => i.value='');
    realImagesList = []; animeImagesList = []; renderImagePreviews('real'); renderImagePreviews('anime');
    showView('home');
  } else { showMsg('submitMsg', res.error); }
}

const POINTS_DISPLAY = { SUBMIT_LOCATION: 200 };

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ADMIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initAdmin() {
  if (!currentUser || !isAdmin(currentUser)) { showView('home'); showToast('error', 'ğŸ”’ à¸„à¸¸à¸“à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸«à¸™à¹‰à¸²à¸™à¸µà¹‰'); return; }
  adminKey = adminKey || 'AUTO_ADMIN_FROM_EMAIL';
  document.getElementById('adminLoginSection').style.display = 'none'; showAdminDashboard();
}
function adminLogin() { const key = document.getElementById('adminKeyInput').value; if (!key) return; adminKey = key; showAdminDashboard(); }
async function showAdminDashboard() {
  const res = await apiGet({ action:'getPendingLocations', userId: currentUser?.userId, token: currentUser?.token, adminKey });
  if (!res.success) { document.getElementById('adminErr').style.display = 'block'; document.getElementById('adminErr').textContent = 'à¸£à¸°à¸šà¸š Admin à¸¡à¸µà¸›à¸±à¸à¸«à¸² à¸«à¸£à¸·à¸­à¸„à¸¸à¸“à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡'; adminKey = ''; return; }

  document.getElementById('adminLoginSection').style.display = 'none'; document.getElementById('adminDashboard').style.display = 'block';
  const stats = await apiGet({ action:'getStats' });
  if (stats.success) { document.getElementById('adminStats').innerHTML = `<div style="text-align:center"><div style="font-size:22px;font-weight:900;color:var(--red)">${stats.stats.pendingLocations}</div><div style="font-size:12px;color:var(--muted)">à¸£à¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š</div></div><div style="text-align:center"><div style="font-size:22px;font-weight:900;color:var(--green)">${stats.stats.totalLocations}</div><div style="font-size:12px;color:var(--muted)">à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¹à¸¥à¹‰à¸§</div></div><div style="text-align:center"><div style="font-size:22px;font-weight:900;color:var(--gold)">${stats.stats.totalUsers}</div><div style="font-size:12px;color:var(--muted)">à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰</div></div>`; }

  if (!res.data.length) { document.getElementById('pendingList').innerHTML = `<div class="empty-state"><div class="empty-icon">âœ…</div><p>à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸£à¸­à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š</p></div>`; return; }

  document.getElementById('pendingList').innerHTML = res.data.map(loc => {
    const realImgList = (loc.real_image_url || '').split(',').map(u=>getDriveImg(u.trim())).filter(u=>u.startsWith('http'));
    const animeImgList = (loc.anime_image_url || '').split(',').map(u=>getDriveImg(u.trim())).filter(u=>u.startsWith('http'));
    const realImg = realImgList[0] || 'https://via.placeholder.com/300x140/1a1a2e/ffffff?text=No+Image';
    const animeImg = animeImgList[0] || 'https://via.placeholder.com/300x140/2d1a1a/ffffff?text=No+Anime+Image';
    
    return `<div class="admin-pending-card" id="pcard_${loc.location_id}"><div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap"><div style="flex:1"><div style="font-size:18px;font-weight:700;margin-bottom:4px">${loc.name_th} <span style="font-size:14px;color:var(--muted)">${loc.name_jp||''}</span></div><div style="font-size:13px;color:var(--red);margin-bottom:6px">ğŸ¬ ${loc.anime_title} ${loc.anime_episode?'Â· '+loc.anime_episode:''}</div><div style="font-size:13px;color:var(--muted)">ğŸ“ ${loc.prefecture} Â· ${loc.address||''}</div><div style="font-size:13px;color:var(--muted)">ğŸ“‚ ${loc.category} Â· à¸¤à¸”à¸¹: ${loc.season} Â· à¹€à¸§à¸¥à¸²: ${loc.opening_hours||'-'}</div><div style="font-size:13px;color:var(--muted);margin-top:4px">à¸ªà¹ˆà¸‡à¹‚à¸”à¸¢: ${loc.submitted_by} Â· ${new Date(loc.submitted_date).toLocaleDateString('th-TH')}</div>${loc.description_th ? `<div style="font-size:13px;margin-top:8px;color:rgba(240,240,245,0.7)">${loc.description_th}</div>` : ''}</div><div style="font-size:12px;color:var(--muted)">Lat: ${loc.lat}<br>Lng: ${loc.lng}</div></div><div class="pending-imgs"><img src="${realImg}" onerror="this.src='https://via.placeholder.com/300x140/1a1a2e/ffffff?text=No+Image'"><img src="${animeImg}" onerror="this.src='https://via.placeholder.com/300x140/2d1a1a/ffffff?text=No+Anime+Image'"></div><div class="admin-actions"><button class="btn btn-green" onclick="adminAction('approve','${loc.location_id}')">âœ… à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´</button><button class="btn btn-red" onclick="adminAction('reject','${loc.location_id}')">âŒ à¸›à¸à¸´à¹€à¸ªà¸˜</button><button class="btn btn-outline" onclick="window.open('https://maps.google.com/?q=${loc.lat},${loc.lng}','_blank')">ğŸ—ºï¸ à¸”à¸¹à¸šà¸™à¹à¸œà¸™à¸—à¸µà¹ˆ</button></div></div>`
  }).join('');
}
async function adminAction(type, locId) {
  if (type === 'approve') {
    const res = await apiPost({ action:'approveLocation', userId: currentUser?.userId, token: currentUser?.token, locationId:locId });
    if (res.success) { showToast('success', 'à¸­à¸™à¸¸à¸¡à¸±à¸•à¸´à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§ âœ…'); document.getElementById('pcard_'+locId)?.remove(); } else showToast('error', res.error);
  } else {
    const reason = prompt('à¹€à¸«à¸•à¸¸à¸œà¸¥à¹ƒà¸™à¸à¸²à¸£à¸›à¸à¸´à¹€à¸ªà¸˜:'); if (reason === null) return;
    const res = await apiPost({ action:'rejectLocation', userId: currentUser?.userId, token: currentUser?.token, locationId:locId, reason });
    if (res.success) { showToast('info', 'à¸›à¸à¸´à¹€à¸ªà¸˜à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§'); document.getElementById('pcard_'+locId)?.remove(); } else showToast('error', res.error);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  AUTH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAuthModal(tab) { openModal('authModal'); switchAuthTab(tab); }
function switchAuthTab(tab) {
  document.getElementById('loginForm').style.display = tab==='login' ? 'block' : 'none';
  document.getElementById('registerForm').style.display = tab==='register' ? 'block' : 'none';
  document.getElementById('tabLogin').classList.toggle('active', tab==='login'); document.getElementById('tabReg').classList.toggle('active', tab==='register');
}
async function doLogin() {
  const id = document.getElementById('loginId').value.trim(); const pw = document.getElementById('loginPw').value;
  if (!id||!pw) { showMsg('loginErr','à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š'); return; }
  const btn = document.querySelector('#loginForm .btn-red'); btn.textContent = 'à¸à¸³à¸¥à¸±à¸‡à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š...'; btn.disabled = true;
  const res = await apiPost({ action:'login', emailOrUser:id, password:pw });
  btn.textContent = 'à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š'; btn.disabled = false;
  if (res.success) {
    currentUser = res; localStorage.setItem('seichi_user', JSON.stringify(currentUser)); updateNavUser(); closeModal('authModal'); showToast('success', `à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸š ${res.display_name}! ğŸŒ`);
    if (pendingCallback) { pendingCallback(); pendingCallback = null; }
  } else { showMsg('loginErr', res.error); }
}
async function doRegister() {
  const u = document.getElementById('regUser').value.trim(); const e = document.getElementById('regEmail').value.trim(); const p = document.getElementById('regPw').value; const p2 = document.getElementById('regPwConfirm').value; const n = document.getElementById('regName').value.trim(); const c = document.getElementById('regCountry').value;
  if (!u||!e||!p) { showMsg('regErr','à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™'); return; }
  if (p.length < 6) { showMsg('regErr','Password à¸•à¹‰à¸­à¸‡à¸¡à¸µà¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹‰à¸­à¸¢ 6 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£'); return; }
  if (p !== p2) { showMsg('regErr','âŒ à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸•à¸£à¸‡à¸à¸±à¸™ à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡'); return; }
  const btn = document.querySelector('#registerForm .btn-red'); btn.textContent = 'à¸à¸³à¸¥à¸±à¸‡à¸ªà¸¡à¸±à¸„à¸£...'; btn.disabled = true;
  const res = await apiPost({ action:'register', username:u, email:e, password:p, display_name:n||u, country:c });
  btn.textContent = 'à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸ à¸Ÿà¸£à¸µ!'; btn.disabled = false;
  if (res.success) {
    currentUser = res; localStorage.setItem('seichi_user', JSON.stringify(currentUser)); updateNavUser(); closeModal('authModal'); showToast('success', `à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! ğŸ‰ à¸£à¸±à¸š ${res.points} à¹à¸•à¹‰à¸¡à¸•à¹‰à¸­à¸™à¸£à¸±à¸š`);
    if (pendingCallback) { pendingCallback(); pendingCallback = null; }
  } else { showMsg('regErr', res.error); }
}
function logout() {
  if (!confirm('à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸šà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?')) return;
  if (currentUser) apiPost({ action:'logout', userId:currentUser.userId, token:currentUser.token });
  currentUser = null; localStorage.removeItem('seichi_user'); updateNavUser(); showView('home'); showToast('info', 'à¸­à¸­à¸à¸ˆà¸²à¸à¸£à¸°à¸šà¸šà¹à¸¥à¹‰à¸§');
}
function isAdmin(user) { return user && ADMIN_EMAILS.includes((user.email || '').toLowerCase().trim()); }
function updateNavUser() {
  const adminBtn = document.getElementById('navAdminBtn');
  if (currentUser) {
    document.getElementById('navUser').style.display = 'none'; document.getElementById('navLoggedIn').style.display = 'flex';
    document.getElementById('navPoints').textContent = Number(currentUser.points||0).toLocaleString();
    const av = document.getElementById('navAvatar'); const avUrl = getDriveImg(currentUser.avatar_url);
    if (avUrl) { av.innerHTML = `<img src="${avUrl}" style="width:100%;height:100%;object-fit:cover;">`; } else { av.innerHTML = (currentUser.username||'U')[0].toUpperCase(); }
    adminBtn.style.display = isAdmin(currentUser) ? 'inline-block' : 'none';
  } else {
    document.getElementById('navUser').style.display = 'flex'; document.getElementById('navLoggedIn').style.display = 'none'; adminBtn.style.display = 'none';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MODAL / TOAST / UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(el => { el.addEventListener('click', e => { if (e.target===el) closeModal(el.id); }); });
function showMsg(id, msg) { const el = document.getElementById(id); if (!el) return; el.textContent = msg; el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 5000); }
function showToast(type, msg) {
  const container = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `<span>${{success:'âœ…',error:'âŒ',info:'â„¹ï¸'}[type]||'ğŸ’¬'}</span><span>${msg}</span>`;
  container.appendChild(t); setTimeout(() => { t.style.opacity='0'; t.style.transform='translateX(60px)'; t.style.transition='.3s'; setTimeout(()=>t.remove(),300); }, 3500);
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open')); });
</script>
</body>
</html>
